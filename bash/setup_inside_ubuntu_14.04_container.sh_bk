#!/bin/bash

# Declare resources
DIR_MOUNT=/home # This must be one of your mount folders.
DIR_WORKING="" # As you wish. "" is also fine.
DOWNLOAD_URL="https://drive.usercontent.google.com/download?id=1UebfhrwJIWfP5cZvdra1tNWVZb8Is9PE&export=download&authuser=0&confirm=t&uuid=5c5a1d80-c934-4688-a7a9-6630f844de42"
DOWNLOAD_FILE_NAME="173v344.7z"

# Declare the structure of the file/folder that must stay inside the DOWNLOAD_FILE_NAME
STRUCTURE='{
    "gfactiond"     : "dir",
    "glinkd"        : "dir",
    "logservice"    : "dir",
    "uniquenamed"   : "dir",
    "authd"         : "dir",
    "gacd"          : "dir",
    "gamed"         : "dir",
    "gamedbd"       : "dir",
    "gdeliveryd"    : "dir"
}' # Do NOT left any trailing comma!!!

# Declare your virtualization info.
# If this IP is not localhost or 127.0.0.1, you may have to add it to /etc/hosts. Remember, this file is reset every time the Container reboots.
YOUR_VIRTUALIZATION_IP=127.0.0.1
YOUR_VIRTUALIZATION="docker" #docker or vmware or virtualbox or empty

# Declare database configuration
DB_NAME=pw
DB_USER=dba
DB_PASSWORD=dba

# Declare web tool configuration
PW_ADMIN_USER="admin"
PW_ADMIN_RAW_PW="admin"
PW_ADMIN_MAIL="admin@gmail.com"

# Declare hash algorithm. "hexEncoding" or "md5AndThenBase64encoding" or empty
#ALGORITHM="hexEncoding"
ALGORITHM="md5AndThenBase64encoding"

# Declare your info
GAME_VERSION=1.7.3
TIMEZONE=Asia/Ho_Chi_Minh

####################################################################################################
####################################################################################################
####################################################################################################
####################################################################################################
####################################################################################################

# Common variables
startTime=""
now=$(date +%Y%m%d_%H%M%S)
currentSQLDate=$(date +'%F %T');
iwebPasswordHash=""
pwAdminPasswordHash=""
workspace=""
if [ -n "${DIR_MOUNT}" ]; then
    workspace="${DIR_MOUNT}"
fi
if [ -n "${DIR_WORKING}" ]; then
    if [ -n "${workspace}" ]; then
        workspace="${workspace}/${DIR_WORKING}"
    else
        workspace="${DIR_WORKING}"
    fi
fi
if [[ "${workspace}" != /* ]]; then
    workspace="/${workspace}"
fi
setupFolder="${workspace}/${now}_setup"
setupLogFile="${workspace}/${now}_setup.log"
mkdir -p "${setupFolder}"
chmod -R 777 "${workspace}"

# Text colors
B="[40;36m"
W="[0m"
G="[1;32m"
R="[1;31m"
Y="[1;33m"
P="[1;95m"

hostnamesResolution="127.0.0.1 AUDATA\n127.0.0.1 audb\n127.0.0.1 aumanager\n127.0.0.1 auth\n127.0.0.1 backup\n127.0.0.1 database\n127.0.0.1 delivery\n127.0.0.1 game1\n127.0.0.1 game2\n127.0.0.1 gm_server\n127.0.0.1 gmserver\n127.0.0.1 link1\n127.0.0.1 LOCAL0\n127.0.0.1 localhost\n127.0.0.1 localhost.localdomain\n127.0.0.1 LogServer\n127.0.0.1 manager\n127.0.0.1 PW-Server"
#hostCommand="if ! grep -q \"127.0.0.1 AUDATA\" /etc/hosts; then echo \"Docker Container reverts the /etc/hosts whenever it restarts. We are re-adding the hostnames resolution automatically...\"; echo -e \"${hostnamesResolution}\" >> /etc/hosts; fi"

function downloadGameServer(){
    #wget -c $DOWNLOAD_URL -O "${setupFolder}/${DOWNLOAD_FILE_NAME}"

    # If you don't want to download file but use an existing one,
    # just place you file in the workspace folder and use this:
    find "${DIR_MOUNT}" -type f -name "$DOWNLOAD_FILE_NAME" -exec rsync -avh {} "${setupFolder}" \; -quit

}

function switchTimezone(){
    ln -sf /usr/share/zoneinfo/$TIMEZONE /etc/localtime
}

function replaceLinesStart() {
    local file=$1
    local startWithText=$2
    local newLineReplacement=$3

    if ! sed -i "/^${startWithText}/c\\${newLineReplacement}" "${file}"; then
        echo -e "replaceLinesStart failed with file ${file}"
        return 1
    fi
}

function replaceLinesContain() {
    local file=$1
    local containText=$2
    local newLine=$3

    if ! sed -i "/${containText}/c\\${newLine}" "${file}"; then
        echo -e "replaceLinesContain failed with file ${file}"
        return 1
    fi
}

function replaceTexts() {
    local file=$1
    local containText=$2
    local newText=$3

    if ! sed -i "s#${containText}#${newText}#g" "${file}"; then
        echo -e "replaceTexts failed with file ${file}"
        return 1
    fi
}

function replaceLineStartInBlock() {
    local file=$1
    local blockName=$2
    local startWithText=$3
    local newLineReplacement=$4

    # Escape special characters in blockName and startWithText
    local escapedBlockName=$(printf '%s\n' "$blockName" | sed 's/[]\/$*.^[]/\\&/g')
    local escapedStartWithText=$(printf '%s\n' "$startWithText" | sed 's/[]\/$*.^[]/\\&/g')

    # Check if the blockName exists in the file by starting with the blockName
    local blockIndex=$(grep -n "^${escapedBlockName}" "${file}" | cut -d: -f1 | head -n 1)
    if [ -z "${blockIndex}" ]; then
        echo -e "Block starting with '${blockName}' not found in the file ${file}."
        return 1
    fi

    # Find the nearest line that starts with startWithText after the blockIndex
    local lineIndex=$(awk -v blockIndex="${blockIndex}" -v startWithText="${escapedStartWithText}" 'NR > blockIndex && $0 ~ "^" startWithText {print NR; exit}' "${file}")
    if [ -z "${lineIndex}" ]; then
        echo -e "No line starting with '${startWithText}' found after block starting with '${blockName}'."
        return 1
    fi

    # Replace the line at lineIndex with newLineReplacement
    if ! sed -i "${lineIndex}s|.*|${newLineReplacement}|" "${file}"; then
        echo -e "replaceLineStartInBlock failed with file ${file}"
        return 1
    fi
}

function installSeverPackages(){

    dpkg --add-architecture i386
    apt-get update && apt-get -y upgrade
    apt-get install -y sudo
    apt-get install -y dialog apt-utils
    apt-get install -y bash curl dpkg iputils-ping jq grep locales mc nano net-tools rsync sed wget
    apt-get install -y p7zip-full p7zip-rar unrar unzip

    # This is a tool to download specific folders from a Github repository.
    curl -sSLfo ./fetch https://github.com/gruntwork-io/fetch/releases/download/v0.4.6/fetch_linux_amd64
    chmod 777 ./fetch

    sudo locale-gen en_US.UTF-8
    sudo update-locale LANG=en_US.UTF-8
    export LC_ALL=en_US.UTF-8

}

function installJdk6Manually(){

    apt-get update
    apt-get install -y openjdk-8-jdk
    chmod -R 777 /usr/lib/jvm
    export JAVA_HOME=$(find /usr/lib/jvm -type d -name "java-*-openjdk*" -print -quit)
    export PATH=$JAVA_HOME/bin:$PATH
    java -version

}

function installDevPackages(){

    apt-get install -y aptitude

    sudo DEBIAN_FRONTEND=noninteractive aptitude install -y gcc g++ gcc-multilib g++-multilib build-essential libssl-dev libssl-dev:i386 libcrypto++-dev libpcre3 libpcre3-dev libpcre3:i386 libpcre3-dev:i386 libtesseract-dev libx11-dev libx11-dev:i386 libc6-dev libc6-dev:i386 libtemplate-plugin-xml-perl libxml2 libxml2-dev libstdc++6 libstdc++6:i386 libdb++-dev libdb-dev libdb5.3 libdb5.3++ libdb5.3++-dev libdb5.3-dbg libdb5.3-dev make libgtk2.0-0:i386 libpangox-1.0-0:i386 libpangoxft-1.0-0:i386 libidn11:i386  libgssapi-krb5-2:i386 coreutils
    sudo aptitude install -y libreadline6-dev:i386

    echo -e "Download additional libraries."
    ./fetch --repo="https://github.com/hoangnguyent/pwtools" --ref="main" --source-path="/additional-libs" "${setupFolder}/additional-libs"
    chmod -R 777 "${setupFolder}/additional-libs"
    cp -f "${setupFolder}/additional-libs/lib"/libcom_err.so.3 /lib
    cp -f "${setupFolder}/additional-libs/lib"/libcrypto.so.4 /lib
    cp -f "${setupFolder}/additional-libs/lib"/libpcre.so.0 /lib
    cp -f "${setupFolder}/additional-libs/lib"/libtask.so /lib
    cp -f "${setupFolder}/additional-libs/lib"/libxml2.so.2 /lib
    #rsync -av --ignore-existing "${setupFolder}/additional-libs/lib"/* /lib

    ldconfig

}

function extractArchive() {
    local archiveFile=$1
    local to=$2

    # Check if the file exists
    if [ ! -f "${archiveFile}" ]; then
        echo -e "File '${archiveFile}' does not exist."
        return 1
    fi

    # Extract the file extension
    local extension="${archiveFile##*.}"

    # Extract the archive based on its extension
    echo -e "Will extract file with extension: [${extension}]"
    case "${extension}" in
        7z)
            timeout 300 7z x -aoa -sccutf-8 -scsutf-8 -o"${to}" "${archiveFile}"
            ;;
        rar)
            timeout 300 unrar x -o+ "${archiveFile}" "${to}"
            ;;
        zip)
            timeout 300 unzip -o "${archiveFile}" -d "${to}"
            ;;
        gz)
            timeout 300 tar -xzf "${archiveFile}" -C "${to}"
            ;;
        *)
            echo -e "Unsupported file extension: ${extension}"
            return 1
            ;;
    esac

    echo -e "Extracted ${archiveFile} to ${to} successfully."
    return 0
}


function findSubFolderWithStructure() {
    local dirToScan=$1
    local structure=$2

    # Check if the directory to scan exists
    if [ ! -d "${dirToScan}" ]; then
        echo "Directory '${dirToScan}' does not exist."
        return 1
    fi

    # Parse the JSON structure
    local keys=$(echo "${structure}" | jq -r 'keys[]')
    local allMatch

    # Scan sub-folders
    for subDir in "${dirToScan}"/*/; do
        allMatch=true
        for key in ${keys}; do
            local type=$(echo "${structure}" | jq -r --arg key "$key" '.[$key]')
            if [ "${type}" == "dir" ]; then
                if [ ! -d "${subDir}${key}" ]; then
                    allMatch=false
                    break
                fi
            elif [ "${type}" == "file" ]; then
                if [ ! -f "${subDir}${key}" ]; then
                    allMatch=false
                    break
                fi
            fi
        done

        if [ "$allMatch" = true ]; then
            echo "${subDir}"
            return
        fi
    done

    # If no matching sub-folder is found, return an empty string
    echo ""
}

function putGameServerFoldersAtRightPlace(){

    echo "Move the game server to right place."

    pathFound=$(findSubFolderWithStructure "${setupFolder}/${now}" "${STRUCTURE}")
    if [ -n "${pathFound}" ]; then
        keys=$(echo "${STRUCTURE}" | jq -r 'keys[]')
        for item in ${keys}; do
            rsync -avh "${pathFound}/${item}" "${workspace}"
            chmod -R 777 "${workspace}/${item}"
        done

    else
        echo -e "No sub-folder that contains the specified structure found."
    fi
}

function extractGameServer(){

    extractArchive "${setupFolder}/${DOWNLOAD_FILE_NAME}" "${setupFolder}/${now}"
    return 0

}

function encodePassword(){

    # salt = user + pass
    iwebPasswordSalt=$(echo "${PW_ADMIN_RAW_PW}" | tr '[:upper:]' '[:lower:]')
    pwAdminPasswordSalt=$(echo "${PW_ADMIN_USER}${PW_ADMIN_RAW_PW}" | tr '[:upper:]' '[:lower:]')

    if [ "$ALGORITHM" == "hexEncoding" ]; then
        iwebPasswordHash=$(hexEncoding "$iwebPasswordSalt")
        pwAdminPasswordHash=$(hexEncoding "$pwAdminPasswordSalt")
    else
        iwebPasswordHash=$(echo -n "$PW_ADMIN_RAW_PW" | openssl dgst -md5 -binary | base64)
        pwAdminPasswordHash=$(echo -n "$pwAdminPasswordSalt" | openssl dgst -md5 -binary | base64)
    fi

}

function hexEncoding() {
    local salt="$1"
    local md5sum
    local hex_string="0x"

    # Generate MD5 hash
    md5sum=$(echo -n "$salt" | md5sum | awk '{print $1}')

    # Convert to uppercase and format as needed
    for (( i=0; i<${#md5sum}; i+=2 )); do
        hex_byte="${md5sum:$i:2}"
        hex_string+="$hex_byte"
    done

    echo "$hex_string"
}

function setupDb() {

    wget -c https://raw.githubusercontent.com/hoangnguyent/pwtools/refs/heads/main/pwa.sql -O "${setupFolder}/pw.sql"

    # Remove mySql if exist
    sudo service mysql stop
    sudo apt-get remove -y --purge mysql-server mysql-client mysql-common
    sudo apt-get autoremove -y
    sudo apt-get autoclean
    sudo rm -rf /etc/mysql /var/lib/mysql

    # Preconfigure the MySQL root password
    echo "mysql-server mysql-server/root_password password 123456" | debconf-set-selections
    echo "mysql-server mysql-server/root_password_again password 123456" | debconf-set-selections

    # Update package list and install MySQL server
    apt-get update
    apt-get install -y mysql-server
    service mysql start

    # Create the database and insert 1 first record.
    mysql -u"root" -p"123456" <<EOF
        DROP DATABASE IF EXISTS $DB_NAME;
        CREATE DATABASE $DB_NAME CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
EOF

    mysql -u"root" -p"123456" "$DB_NAME" < "${setupFolder}/pw.sql"

    mysql -u"root" -p"123456" "$DB_NAME" <<EOF
        CALL adduser("$PW_ADMIN_USER", "$pwAdminPasswordHash", "0", "0", "super admin", "0.0.0.0", "$PW_ADMIN_MAIL", "0", "0", "0", "0", "0", "0", "0", "$currentSQLDate", " ", "$pwAdminPasswordHash");
EOF

    lastInsertedUserId=$(mysql -u"root" -p"123456" "$DB_NAME" -se "SELECT ID from users WHERE name=\"$PW_ADMIN_USER\"");
    echo "last inserted id: $lastInsertedUserId";
    if [[ "$lastInsertedUserId" =~ ^[0-9]+$ ]]; then
        mysql -u"root" -p"123456" "$DB_NAME" <<EOF
            CALL addGM("$lastInsertedUserId", "1");
            INSERT INTO usecashnow (userid, zoneid, sn, aid, point, cash, status, creatime) VALUES ("$lastInsertedUserId", "1", "0", "1", "0", "100000", "1", "$currentSQLDate") ON DUPLICATE KEY UPDATE cash = cash + 100000;
EOF
    fi

}

function enableToConnectDbFromOutside(){

    service mysql start

    # Grant permissions
    user_exists=$(mysql -u"root" -p"123456" -se "SELECT EXISTS(SELECT 1 FROM mysql.user WHERE user = '$DB_USER' AND host = 'localhost');")
    if [ "$user_exists" -eq 1 ]; then
        mysql -u"root" -p"123456" -e "DROP USER '$DB_USER'@'localhost';"
    fi
    mysql -u"root" -p"123456" -e "CREATE USER '$DB_USER'@'localhost' IDENTIFIED BY '$DB_PASSWORD';"
    mysql -u"root" -p"123456" -e "GRANT ALL PRIVILEGES ON *.* TO '$DB_USER'@'localhost';"
    mysql -u"root" -p"123456" -e "GRANT ALL PRIVILEGES ON pw.* TO '$DB_USER'@'localhost';"

    user_exists=$(mysql -u"root" -p"123456" -se "SELECT EXISTS(SELECT 1 FROM mysql.user WHERE user = '$DB_USER' AND host = '${YOUR_VIRTUALIZATION_IP}');")
    if [ "$user_exists" -eq 1 ]; then
        mysql -u"root" -p"123456" -e "DROP USER '$DB_USER'@'${YOUR_VIRTUALIZATION_IP}';"
    fi
    mysql -u"root" -p"123456" -e "CREATE USER '$DB_USER'@'${YOUR_VIRTUALIZATION_IP}' IDENTIFIED BY '$DB_PASSWORD';"
    mysql -u"root" -p"123456" -e "GRANT ALL PRIVILEGES ON *.* TO '$DB_USER'@'${YOUR_VIRTUALIZATION_IP}';"
    mysql -u"root" -p"123456" -e "GRANT ALL PRIVILEGES ON pw.* TO '$DB_USER'@'${YOUR_VIRTUALIZATION_IP}';"

    user_exists=$(mysql -u"root" -p"123456" -se "SELECT EXISTS(SELECT 1 FROM mysql.user WHERE user = '$DB_USER' AND host = '172.17.0.1');") # these are for Docker container only
    if [ "$user_exists" -eq 1 ]; then
        mysql -u"root" -p"123456" -e "DROP USER '$DB_USER'@'172.17.0.1';"
    fi
    mysql -u"root" -p"123456" -e "CREATE USER '$DB_USER'@'172.17.0.1' IDENTIFIED BY '$DB_PASSWORD';"
    mysql -u"root" -p"123456" -e "GRANT ALL PRIVILEGES ON *.* TO '$DB_USER'@'172.17.0.1';"
    mysql -u"root" -p"123456" -e "GRANT ALL PRIVILEGES ON pw.* TO '$DB_USER'@'172.17.0.1';"


    mysql -u"root" -p"123456" -e "FLUSH PRIVILEGES;"

    # Allow all IP addresses outside the container.
    replaceLinesStart "/etc/mysql/my.cnf" "log_error" "log_error = /var/log/mysql/error.log"
    replaceLinesStart "/etc/mysql/my.cnf" "bind-address" "bind-address = 0.0.0.0"
    replaceLinesStart "/etc/mysql/my.cnf" "log_error" "log_error = /var/log/mysql/error.log"
    echo -e "skip-name-resolve" | sudo tee -a /etc/mysql/my.cnf

    service mysql restart

}


function setupIwebJava(){

    if [ ! -d "${workspace}/tomcat" ]; then
        mkdir "${workspace}/tomcat"
        chmod -R 777 "${workspace}/tomcat"
    else
        rm -rf "${workspace}/tomcat"/*
    fi

    # Download Tomcat
    wget https://archive.apache.org/dist/tomcat/tomcat-7/v7.0.108/bin/apache-tomcat-7.0.108.tar.gz && tar -xzf apache-tomcat-7.0.108.tar.gz -C "${workspace}/tomcat" --strip-components=1
    chmod -R 777 "${workspace}/tomcat/bin"

    # Use my pwadmin (iweb)
    rm -rf "${workspace}"/tomcat/webapps/pwadmin
    ./fetch --repo="https://github.com/hoangnguyent/pwtools" --ref="main" --source-path="/pwadmin" "${workspace}"/tomcat/webapps/pwadmin

    # Override file /tomcat/webapps/pwadmin/WEB-INF/.pwadminconf.jsp: DB connection; game location; hash algorithm for iweb password.
    replaceLinesContain "${workspace}/tomcat/webapps/pwadmin/WEB-INF/.pwadminconf.jsp" "String db_host = " "String db_host = \"$YOUR_VIRTUALIZATION_IP\";"
    replaceLinesContain "${workspace}/tomcat/webapps/pwadmin/WEB-INF/.pwadminconf.jsp" "String db_user = " "String db_user = \"$DB_USER\";"
    replaceLinesContain "${workspace}/tomcat/webapps/pwadmin/WEB-INF/.pwadminconf.jsp" "String db_password = " "String db_password = \"$DB_PASSWORD\";"
    replaceLinesContain "${workspace}/tomcat/webapps/pwadmin/WEB-INF/.pwadminconf.jsp" "String db_database = " "String db_database = \"$DB_NAME\";"
    replaceLinesContain "${workspace}/tomcat/webapps/pwadmin/WEB-INF/.pwadminconf.jsp" "String algorithm = " "String algorithm = \"$ALGORITHM\";"
    replaceLinesContain "${workspace}/tomcat/webapps/pwadmin/WEB-INF/.pwadminconf.jsp" "String iweb_password = " "String iweb_password = \"$iwebPasswordHash\";"
    replaceLinesContain "${workspace}/tomcat/webapps/pwadmin/WEB-INF/.pwadminconf.jsp" "String pw_server_path = " "String pw_server_path = \"${workspace}/\";"
    replaceLinesContain "${workspace}/tomcat/webapps/pwadmin/WEB-INF/.pwadminconf.jsp" "String pw_server_name = " "String pw_server_name = \"${workspace}\";"

    # Override file /tomcat/webapps/pwadmin/addons/Top Players - Manual Refresh/index.jsp: DB connection. Replace the line that contains a text with a whole new line
    replaceLinesContain "${workspace}/tomcat/webapps/pwadmin/addons/Top Players - Manual Refresh/index.jsp" "connection = DriverManager.getConnection(" "connection = DriverManager.getConnection(\"jdbc:mysql://$YOUR_VIRTUALIZATION_IP:3306/$DB_NAME?useUnicode=true&characterEncoding=utf8\", \"$DB_USER\", \"$db_password\");"

}

function translateMapsIntoVietnamese() {

    echo -e "yes,gs01,Tháº¿ Giá»›i
yes,is61,Tháº¿ Giá»›i NgÆ°á»i Má»›i (1.5.3)
no,is62,Khung Tháº¿ Giá»›i (1.5.1)
no,is01,ThÃ nh Phá»‘ Tá»™i Ãc
no,is02,ÄÆ°á»ng Háº§m BÃ­ Máº­t
no,is03,na
no,is04,na
no,is05,Hang Äá»™ng Lá»­a
no,is06,Hang SÃ³i ÄiÃªn
no,is07,Hang Äá»™ng TÃ n Ãc
no,is08,Äáº¡i Sáº£nh Lá»«a Dá»‘i
no,is09,Cá»•ng áº¢o GiÃ¡c
no,is10,ThÃ nh Phá»‘ BÄƒng GiÃ¡ BÃ­ Máº­t
no,is11,Thung LÅ©ng Tháº£m Há»a
no,is12,TÃ n TÃ­ch Rá»«ng
no,is13,Hang Äá»™ng Vui SÆ°á»›ng TÃ n Báº¡o
no,is14,Cá»•ng Ma QuÃ¡i
no,is15,HÃ o Trench áº¢o GiÃ¡c
no,is16,Eden
no,is17,Há»‘ Lá»­a
no,is18,Äá»n Rá»“ng
no,is19,Äáº£o Tiáº¿ng ThÃ©t ÄÃªm
no,is20,Äáº£o Ráº¯n
yes,is21,Lothranis
yes,is22,Momaganon
no,is23,Ngai TÃ²a Äau Khá»•
no,is24,Ma Vá»±c ÄÃ o NguyÃªn
no,is25,Chiáº¿n Ca Chi ThÃ nh
no,is26,LuÃ¢n Há»“i Äiá»‡n
no,is27,Tháº§n Nguyá»‡t Cá»‘c
no,is28,Tháº§n VÃ´ Cá»‘c
no,is29,PhÃºc SÆ°Æ¡ng ThÃ nh
no,is31,HoÃ ng HÃ´n ThÃ¡nh Äiá»‡n
no,is32,Váº­n Má»‡nh Ma PhÆ°Æ¡ng
no,is33,ThiÃªn Lá»‡ Chi ThÃ nh
no,is34,Khung cáº£nh HÃ´n Lá»…
no,is35,Phá»¥ báº£n Bang PhÃ¡i
no,is37,Bá»“ng Lai Huyá»…n Cáº£nh
no,is38,PhÆ°á»£ng Minh Cá»‘c
no,is39,VÃ´ Äá»‹nh Trá»¥
no,is40,Tháº§n Äá»™c Chi Gian
no,is41,VÃ´ Äá»Šnh Trá»¥-mÃ´ thá»©c cáº¥p cao
no,is42,Chiáº¿n Tháº§n Cá»‘c
no,is43,NgÅ© Äáº¿ Chi ÄÃ´
no,is44,Quá»‘c Chiáº¿n-CÃ´ Äáº£o Äoáº¡t KÃ¬
no,is45,Quá»‘c Chiáº¿n-Äoáº¡n Kiá»u Äá»‘i TrÃ¬
no,is46,Quá»‘c Chiáº¿n-Thá»§y Tinh Tranh Äoáº¡t
no,is47,Láº¡c Nháº­t Cá»‘c
no,is48,Báº¥t XÃ¡ ÄÆ°á»ng
no,is49,Long áº¨n Quáº­t
no,is50,Linh ÄÃ n Huyá»…n Cáº£nh
yes,is63,NhÃ¢n Giá»›i
no,is66,LÆ°u NgÃ¢n Cung
no,is67,Phá»¥c Ba ÄÆ°á»ng
yes,is68,MÃ´ thá»©c CÃ¢u chuyá»‡n NhÃ¢n Giá»›i
yes,is69,Bá»“ng Minh Äá»™ng
no,is70,Váº­n Má»‡nh Ma PhÆ°Æ¡ng (2)
no,is71,Thiá»‡n Long Cá»‘c
no,is72,Tru ThiÃªn PhÃ¹ Äá»“ ThÃ¡p (base)
no,is73,Tru ThiÃªn PhÃ¹ Äá»“ ThÃ¡p (is73)
no,is74,Tru ThiÃªn PhÃ¹ Äá»“ ThÃ¡p (is74)
no,is75,Tru ThiÃªn PhÃ¹ Äá»“ ThÃ¡p (is75)
no,is76,Huyá»…n Háº£i KÃ¬ ÄÃ m
no,is77,Thurs Fights Cross
yes,is78,Äáº¡i Lá»¥c HoÃ n MÄ© - TÃ¢y Lá»¥c
no,is80,LÄƒng VÃ¢n Giá»›i
no,is81,LÄƒng VÃ¢n Giá»›i
no,is82,LÄƒng VÃ¢n Giá»›i
no,is83,LÄƒng VÃ¢n Giá»›i
no,bg01,Äáº¥u trÆ°á»ng T-3 PvP
no,bg02,Äáº¥u trÆ°á»ng T-3 PvE
no,bg03,Äáº¥u trÆ°á»ng T-2 PvP
no,bg04,Äáº¥u trÆ°á»ng T-2 PvE
no,bg05,Äáº¥u trÆ°á»ng T-1 PvP
no,bg06,Äáº¥u trÆ°á»ng T-1 PvE
no,arena01,Äáº¥u trÆ°á»ng Kiáº¿m TiÃªn ThÃ nh
no,arena02,Äáº¥u trÆ°á»ng Váº¡n HÃ³a ThÃ nh
no,arena03,Äáº¥u trÆ°á»ng TÃ­ch VÅ© ThÃ nh
no,arena04,Äáº¥u trÆ°á»ng Tá»• Long ThÃ nh
no,rand03,Huyá»…n Sa Tháº­n Cáº£nh
no,rand04,MÃª Sa Huyá»…n Cáº£nh
" > "${workspace}/maps"

}

function translateIwebIntoVietnamese() {

    # Enable UTF-8 on the page.
    sed -i '1i <%@page contentType="text/html; charset=UTF-8" %>' "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp"

    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "City of Abominations" "Minh ThÃº ThÃ nh"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Secret Passage" "Anh HÃ¹ng Trá»§ng"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Firecrag Grotto" "Há»a Nham Äá»™ng Huyá»‡t"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Den of Rabid Wolves" "Cuá»“ng Lang SÃ o Huyá»‡t"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Cave of the Vicious" "XÃ  Háº¡t Äá»™ng"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Hall of Deception" "Thanh Y Trá»§ng"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Gate of Delirium" "U Minh CÆ°"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Secret Frostcover Grounds" "LÃ­ SÆ°Æ¡ng BÃ­ Cáº£nh"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Valley of Disaster" "ThiÃªn Kiáº¿p Cá»‘c"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Forest Ruins" "TÃ¹ng LÃ¢m Di TÃ­ch"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Cave of Sadistic Glee" "Quá»· Vá»±c Huyá»…n Cáº£nh"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Wraithgate" "OÃ¡n Linh Chi MÃ´n"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Hallucinatory Trench" "BÃ­ Báº£o Quáº­t"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Eden" "TiÃªn Huyá»…n ThiÃªn"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Brimstone Pit" "Ma Huyá»…n ThiÃªn"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Temple of the Dragon" "Long Cung"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Nightscream Island" "Dáº¡ Khá»‘c Äáº£o"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Snake Isle" "Váº¡n XÃ  Äáº£o"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Lothranis" "TiÃªn giá»›i"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Momaganon" "Ma giá»›i"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Seat of Torment" "ThiÃªn Giá»›i Luyá»‡n Ngá»¥c"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Abaddon" "Ma Vá»±c ÄÃ o NguyÃªn"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Warsong City" "Chiáº¿n Ca Chi ThÃ nh"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Palace of Nirvana" "LuÃ¢n Há»“i Äiá»‡n"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Lunar Glade" "Tháº§n Nguyá»‡t Cá»‘c"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Valley of Reciprocity" "Tháº§n VÃ´ Cá»‘c"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Frostcover City" "PhÃºc SÆ°Æ¡ng ThÃ nh"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Twilight Temple" "HoÃ ng HÃ´n ThÃ¡nh Äiá»‡n"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Cube of Fate" "Váº­n Má»‡nh Ma PhÆ°Æ¡ng"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Chrono City" "ThiÃªn Lá»‡ Chi ThÃ nh"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Perfect Chapel" "Khung cáº£nh HÃ´n Lá»…"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Guild Base" "Phá»¥ báº£n Bang PhÃ¡i"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Morai" "Bá»“ng Lai Huyá»…n Cáº£nh"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Phoenix Valley" "PhÆ°á»£ng Minh Cá»‘c"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Endless Universe" "VÃ´ Äá»‹nh Trá»¥"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Blighted Chamer" "Tháº§n Äá»™c Chi Gian"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Endless Universe" "VÃ´ Äá»Šnh Trá»¥-mÃ´ thá»©c cáº¥p cao"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Wargod Gulch" "Chiáº¿n Tháº§n Cá»‘c"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Five Emperors" "NgÅ© Äáº¿ Chi ÄÃ´"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Nation War 2" "Quá»‘c Chiáº¿n-CÃ´ Äáº£o Äoáº¡t KÃ¬"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Nation Wa TOWER" "Quá»‘c Chiáº¿n-Thá»§y Tinh Tranh Äoáº¡t"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Nation War CRYSTAL" "Quá»‘c Chiáº¿n-Äoáº¡n Kiá»u Äá»‘i TrÃ¬"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Sunset Valley" "Láº¡c Nháº­t Cá»‘c"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Shutter Palace" "Báº¥t XÃ¡ ÄÆ°á»ng"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Dragon Hidden Den" "Long áº¨n Quáº­t"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Realm of Reflection" "Linh ÄÃ n Huyá»…n Cáº£nh"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "startpoint" "Linh Äá»™ Äinh ChÃ¢u"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Origination" "Khung Tháº¿ Giá»›i"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Primal World" "NhÃ¢n Giá»›i"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Flowsilver Palace" "LÆ°u NgÃ¢n Cung"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Undercurrent Hall" "Phá»¥c Ba ÄÆ°á»ng"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Mortal Realm" "MÃ´ thá»©c CÃ¢u chuyá»‡n NhÃ¢n Giá»›i"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "LightSail Cave" "Bá»“ng Minh Äá»™ng"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Cube of Fate (2)" "Váº­n Má»‡nh Ma PhÆ°Æ¡ng (2)"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "dragon counqest" "Thiá»‡n Long Cá»‘c"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "heavenfall temple" "Tru ThiÃªn PhÃ¹ Äá»“ ThÃ¡p"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "heavenfall temple" "Tru ThiÃªn PhÃ¹ Äá»“ ThÃ¡p"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "heavenfall temple" "Tru ThiÃªn PhÃ¹ Äá»“ ThÃ¡p"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "heavenfall temple" "Tru ThiÃªn PhÃ¹ Äá»“ ThÃ¡p"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Uncharted Paradise" "Huyá»…n Háº£i KÃ¬ ÄÃ m"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Thurs Fights Cross" "Thurs Fights Cross"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Western Steppes" "Äáº¡i Lá»¥c HoÃ n MÄ© - TÃ¢y Lá»¥c"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Homestead, Beyond the Clouds" "LÄƒng VÃ¢n Giá»›i"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Homestead, Beyond the Clouds" "LÄƒng VÃ¢n Giá»›i"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Homestead, Beyond the Clouds" "LÄƒng VÃ¢n Giá»›i"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Homestead, Beyond the Clouds" "LÄƒng VÃ¢n Giá»›i"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Grape Valley, Grape Valley" "Grape Valley"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Nemesis Gaunntlet, Museum" "Linh Lung Cá»¥c"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Dawnlight Halls, Palace of the Dawn (DR 1)" "Thá»± Quang Äiá»‡n (DR 1)"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Mirage Lake, Mirage Lake" "Huyá»…n Cáº£nh Tháº­n Há»“"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Rosesand Ruins, Desert Ruins" "CÃ´i Máº¡c TÃ n ViÃªn"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Nightmare Woods, Forest Ruins" "Yá»ƒm LÃ¢m Pháº¿ KhÆ°"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Advisors Sanctum, Palace of the Dawn (DR 2)" "Thá»± Quang Äiá»‡n (DR 2)"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Wonderland, Adventure Kingdom (Park)" "KÃ¬ Láº¡c Máº¡o Hiá»ƒm VÆ°Æ¡ng Quá»‘c"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "The Indestructible City" "MÃ´ thá»©c cÃ¢u chuyá»‡n TÃ¢y Lá»¥c"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Phoenix Sanctum, Hall of Fame" "Phoenix Sanctum, Hall of Fame"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Town of Arrivals, Battlefield - Dusk Outpost" "Æ¯á»›c chiáº¿n LiÃªn server - Long Chiáº¿n Chi DÃ£"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Icebound Underworld, Ice Hell (LA)" "BÄƒng Vá»ng Äá»‹a Ngá»¥c"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Doosan Station, Arena of the Gods" "Doosan Station, Arena of the Gods"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Alt TT Revisited, Twilight Palace" "Alt TT Revisited, Twilight Palace"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Spring Pass, Peach Abode (Mentoring)" "Spring Pass, Peach Abode (Mentoring)"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Abode of Dreams" "Abode of Dreams"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "White Wolf Pass" "White Wolf Pass"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Imperial Battle" "Imperial Battle"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Northern Lands" "Northern Lands"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Altar of the Virgin" "Altar of the Virgin"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Imperial Battle" "Imperial Battle"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Northern Lands" "Northern Lands"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Full Moon Pavilion" "Full Moon Pavilion"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Abode of Changes" "Abode of Changes"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "quicksand maze" "quicksand maze"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "quicksand maze" "quicksand maze"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Territory War T-3 PvP" "Äáº¥u trÆ°á»ng T-3 PvP"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Territory War T-3 PvE" "Äáº¥u trÆ°á»ng T-3 PvE"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Territory War T-2 PvP" "Äáº¥u trÆ°á»ng T-2 PvP"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Territory War T-2 PvE" "Äáº¥u trÆ°á»ng T-2 PvE"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Territory War T-1 PvP" "Äáº¥u trÆ°á»ng T-1 PvP"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Territory War T-1 PvE" "Äáº¥u trÆ°á»ng T-1 PvE"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Etherblade Arena" "Äáº¥u trÆ°á»ng Kiáº¿m TiÃªn ThÃ nh"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Lost Arena" "Äáº¥u trÆ°á»ng Váº¡n HÃ³a ThÃ nh"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Plume Arena" "Äáº¥u trÆ°á»ng TÃ­ch VÅ© ThÃ nh"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Archosaur Arenas" "Äáº¥u trÆ°á»ng Tá»• Long ThÃ nh"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Quicksand Maze (Sandstorm Mirage)" "Huyá»…n Sa Tháº­n Cáº£nh"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Quicksand Maze (Mirage of the wandering sands)" "MÃª Sa Huyá»…n Cáº£nh"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Tomb of Whispers" "Tomb of Whispers"

    # CÃ³ nhiá»u map mÃ¬nh khÃ´ng tÃ¬m Ä‘Æ°á»£c tÃªn tiáº¿ng Viá»‡t, tháº­m chÃ­ dá»‹ch bá»«a. Ai biáº¿t, xin chá»‰ giÃ¹m nhÃ©.
}

function setupWebTools() {

    setupIwebJava

    # Other tools will be placed here.
}

function composeStartAndStopScript(){

    # Download scripts
    ./fetch --repo="https://github.com/hoangnguyent/pwtools" --ref="main" --source-path="/bash" "${setupFolder}/bash"
    chmod -R 777 "${setupFolder}/bash"
    cp "${setupFolder}/bash"/server "${workspace}"
    cp "${setupFolder}/bash"/start "${workspace}"
    cp "${setupFolder}/bash"/stop "${workspace}"

    # Override file 'server' file : DB connection; [pwadmin] web tool location; and other info.
    replaceLinesStart "${workspace}/server" "# Last Updated:" "# Last Updated: $(date +'%Y/%m/%d')"
    replaceLinesStart "${workspace}/server" "# Require:" "# Require: Perfect World server v$GAME_VERSION"
    replaceLinesStart "${workspace}/server" "ServerDir=" "ServerDir=${workspace}"
    replaceLinesStart "${workspace}/server" "USR=" "USR=$DB_USER"
    replaceLinesStart "${workspace}/server" "PASSWD=" "PASSWD=$DB_PASSWORD"
    replaceLinesStart "${workspace}/server" "DB=" "DB=$DB_NAME"
    replaceLinesStart "${workspace}/server" "DIR_TOMCAT_BIN=" "DIR_TOMCAT_BIN=${workspace}/tomcat/bin"

    # Override the 'start' file
    replaceLinesStart "${workspace}/start" "PW_PATH=" "PW_PATH=${workspace}"
    replaceLinesContain "${workspace}/start" "# display pwadmin url here" "    echo \${G}\"http://${YOUR_VIRTUALIZATION_IP}:8080/pwadmin\"\${W}"
    replaceLinesContain "${workspace}/start" "# display warning about hosts here" "${hostCommand}"
    jdbcCommand="    echo \"Use: \${G}jdbc:mysql://$YOUR_VIRTUALIZATION_IP:3306/$DB_NAME?user=$DB_USER&password=$DB_PASSWORD\${W} to connect the DB from outside the Docker container.\""
    replaceLinesContain "${workspace}/start" "# display jdbc string here" "${jdbcCommand}"

    # Override the test files (9). You should run them in this order.
    #cp "${setupFolder}/bash/test_"* "${workspace}"
    #replaceLinesStart "${workspace}/test_start_logservice" "PW_PATH=" "PW_PATH=${workspace}"
    #replaceLinesStart "${workspace}/test_start_uniquenamed" "PW_PATH=" "PW_PATH=${workspace}"
    #replaceLinesStart "${workspace}/test_start_authd" "PW_PATH=" "PW_PATH=${workspace}"
    #replaceLinesStart "${workspace}/test_start_gamedbd" "PW_PATH=" "PW_PATH=${workspace}"
    #replaceLinesStart "${workspace}/test_start_gacd" "PW_PATH=" "PW_PATH=${workspace}"
    #replaceLinesStart "${workspace}/test_start_gfactiond" "PW_PATH=" "PW_PATH=${workspace}"
    #replaceLinesStart "${workspace}/test_start_gdeliveryd" "PW_PATH=" "PW_PATH=${workspace}"
    #replaceLinesStart "${workspace}/test_start_glinkd" "PW_PATH=" "PW_PATH=${workspace}"
    #replaceLinesStart "${workspace}/test_start_gamed" "PW_PATH=" "PW_PATH=${workspace}"

    # Move start/stop to /
    mv -f "${workspace}/start" /
    mv -f "${workspace}/stop" /

    # Create file restart
    echo -e "./stop\n./start \"\$@\"" > "restart"

    # Grant permission
    chmod 777 "${workspace}/test_"*
    chmod 777 "start"
    chmod 777 "stop"
    chmod 777 "restart"

}

function setupGameServer(){

    # Override file /authd/authd. Sometimes this file stays in /build folder.
    path_table_xml=$(find "${workspace}/authd" -name "table.xml" -print -quit)

    if [ -n "${path_table_xml}" ]; then
        authd_path=$(dirname "${path_table_xml}")
        cat << EOF > "${authd_path}/authd"
#!/bin/sh
while true; do
    "${JAVA_HOME}/bin/java" -cp lib/application.jar:.:lib/commons-collections-3.1.jar:lib/commons-dbcp-1.2.1.jar:lib/commons-logging-1.0.4.jar:lib/commons-pool-1.2.jar:lib/jio.jar:lib/log4j-1.2.9.jar:lib/mysql-connector-java-5.1.10-bin.jar:.:.:"${JAVA_HOME}/lib/dt.jar":"${JAVA_HOME}/lib/tools.jar" authd table.xml
    sleep 2
done
EOF
    fi

    echo "authd location is: ${authd_path}"
    echo "table.xml location is: ${path_table_xml}"

    # Override file /authd/authd.conf
    replaceLineStartInBlock "${authd_path}/authd.conf" "[GAuthServer]" "mtrace" "mtrace = ${authd_path}/mtrace.authd"

    # Override file /authd/table.xml and copy it to /etc
    replaceLinesStart "${path_table_xml}" "<connection name=\"auth0\" poolsize=\"3\" url=\"jdbc:mysql" "<connection name=\"auth0\" poolsize=\"3\" url=\"jdbc:mysql://$YOUR_VIRTUALIZATION_IP:3306/$DB_NAME?useUnicode=true&amp;characterEncoding=utf8&amp;jdbcCompliantTruncation=false\" username=\"$DB_USER\" password=\"$DB_PASSWORD\"/>"

    # Override file /authd/log4j.properties
    echo "### direct log messages to CONSOLE ###
log4j.appender.CONSOLE=org.apache.log4j.ConsoleAppender
log4j.appender.CONSOLE.Target=System.out
log4j.appender.CONSOLE.layout=org.apache.log4j.PatternLayout
log4j.appender.CONSOLE.layout.ConversionPattern=gauthd: %d{dd MMM yyyy HH:mm:ss,SSS} %5p %c{1}:%L - %m%n
log4j.appender.CONSOLE.Threshold=TRACE

log4j.appender.SYSLOG=org.apache.log4j.net.SyslogAppender
log4j.appender.SYSLOG.facility=LOCAL0 
log4j.appender.SYSLOG.layout=org.apache.log4j.PatternLayout 
log4j.appender.SYSLOG.layout.ConversionPattern=gauthd: %-5p - %m%n 
log4j.appender.SYSLOG.SyslogHost=localhost
log4j.appender.SYSLOG.Threshold=TRACE

# Set root logger to TRACE level
log4j.rootLogger=trace, CONSOLE, SYSLOG
" > "${authd_path}/log4j.properties"

    # Override file /gacd/gamesys.conf
    replaceLinesContain "${workspace}/gacd/gamesys.conf" "mtrace" "mtrace = ${workspace}/logs/gacd.log"

    # Override file /gamed/gmserver.conf
    replaceLinesStart "${workspace}/gamed/gmserver.conf" "address" "address = 127.0.0.1"

    # Override file /gamed/gs.conf
    replaceLinesStart "${workspace}/gamed/gs.conf" "Root" "Root = ${workspace}/gamed/config"
    replaceLineStartInBlock "${workspace}/gamed/gs.conf" "[MsgTCPSession]" "address" "address = 127.0.0.1"

    # Override file /gamedbd/gamesys.conf
    replaceLineStartInBlock "${workspace}/gamedbd/gamesys.conf" "[storage]" "homedir" "homedir = ${workspace}/gamedbd/dbhome"
    replaceLineStartInBlock "${workspace}/gamedbd/gamesys.conf" "[storage]" "datadir" "datadir = ${workspace}/gamedbd/dbhome/dbdata"
    replaceLineStartInBlock "${workspace}/gamedbd/gamesys.conf" "[storage]" "logdir" "logdir = ${workspace}/gamedbd/dbhome/dblogs"
    replaceLineStartInBlock "${workspace}/gamedbd/gamesys.conf" "[storage]" "backupdir" "backupdir = ${workspace}/gamedbd/dbhome/backup"
    replaceLineStartInBlock "${workspace}/gamedbd/gamesys.conf" "[storage]" "cachesize" "cachesize = 99999999"
    replaceLineStartInBlock "${workspace}/gamedbd/gamesys.conf" "[storagewdb]" "homedir" "homedir = ${workspace}/gamedbd/dbhomewdb"
    replaceLineStartInBlock "${workspace}/gamedbd/gamesys.conf" "[storagewdb]" "datadir" "datadir = ${workspace}/gamedbd/dbhomewdb/dbdata"
    replaceLineStartInBlock "${workspace}/gamedbd/gamesys.conf" "[storagewdb]" "logdir" "logdir = ${workspace}/gamedbd/dbhomewdb/dblogs"
    replaceLineStartInBlock "${workspace}/gamedbd/gamesys.conf" "[storagewdb]" "backupdir" "backupdir = ${workspace}/gamedbd/dbhomewdb/backup"

    # Override file /gdeliveryd/gamesys.conf
    replaceLineStartInBlock "${workspace}/gdeliveryd/gamesys.conf" "[LogclientClient]" "address" "address = 127.0.0.1"
    replaceLineStartInBlock "${workspace}/gdeliveryd/gamesys.conf" "[LogclientTcpClient]" "address" "address = 127.0.0.1"
    replaceLineStartInBlock "${workspace}/gdeliveryd/gamesys.conf" "[GDeliveryServer]" "address" "address = 127.0.0.1"
    replaceLineStartInBlock "${workspace}/gdeliveryd/gamesys.conf" "[GAuthClient]" "address" "address = 127.0.0.1"
    replaceLineStartInBlock "${workspace}/gdeliveryd/gamesys.conf" "[GProviderServer]" "address" "address = 127.0.0.1"
    replaceLineStartInBlock "${workspace}/gdeliveryd/gamesys.conf" "[UniqueNameClient]" "address" "address = 127.0.0.1"
    replaceLineStartInBlock "${workspace}/gdeliveryd/gamesys.conf" "[GameDBClient]" "address" "address = 127.0.0.1"
    replaceLineStartInBlock "${workspace}/gdeliveryd/gamesys.conf" "[GAntiCheatClient]" "address" "address = 127.0.0.1"
    replaceLineStartInBlock "${workspace}/gdeliveryd/gamesys.conf" "[GFactionClient]" "address" "address = 127.0.0.1"
    replaceLineStartInBlock "${workspace}/gdeliveryd/gamesys.conf" "[CentralDeliveryServer]" "address" "address = 0.0.0.0"
    replaceLineStartInBlock "${workspace}/gdeliveryd/gamesys.conf" "[CentralDeliveryClient]" "address" "address = host.docker.internal"
    yourVirtualization=$(echo "$YOUR_VIRTUALIZATION" | tr '[:upper:]' '[:lower:]')
    if [[ "${yourVirtualization}" == *"docker"* ]]; then
        replaceLineStartInBlock "${workspace}/gdeliveryd/gamesys.conf" "[CentralDeliveryClient]" "address" "address = host.docker.internal"
    else
        replaceLineStartInBlock "${workspace}/gdeliveryd/gamesys.conf" "[CentralDeliveryClient]" "address" "address = ${YOUR_VIRTUALIZATION_IP}"
    fi

    # Override file /glinkd/gamesys.conf
    replaceLineStartInBlock "${workspace}/glinkd/gamesys.conf" "[GLinkServer1]" "address" "address = 0.0.0.0"
    replaceLineStartInBlock "${workspace}/glinkd/gamesys.conf" "[GLinkServer2]" "address" "address = 0.0.0.0"
    replaceLineStartInBlock "${workspace}/glinkd/gamesys.conf" "[GLinkServer3]" "address" "address = 0.0.0.0"
    replaceLineStartInBlock "${workspace}/glinkd/gamesys.conf" "[GLinkServer4]" "address" "address = 0.0.0.0"
    replaceLineStartInBlock "${workspace}/glinkd/gamesys.conf" "[GLinkServer5]" "address" "address = 0.0.0.0"
    replaceLineStartInBlock "${workspace}/glinkd/gamesys.conf" "[GLinkServer6]" "address" "address = 0.0.0.0"
    replaceLineStartInBlock "${workspace}/glinkd/gamesys.conf" "[GLinkServer7]" "address" "address = 0.0.0.0"
    replaceLineStartInBlock "${workspace}/glinkd/gamesys.conf" "[GDeliveryClient]" "address" "address = 127.0.0.1"
    replaceLineStartInBlock "${workspace}/glinkd/gamesys.conf" "[GProviderServer1]" "address" "address = 127.0.0.1"
    replaceLineStartInBlock "${workspace}/glinkd/gamesys.conf" "[GProviderServer2]" "address" "address = 127.0.0.1"
    replaceLineStartInBlock "${workspace}/glinkd/gamesys.conf" "[GProviderServer3]" "address" "address = 127.0.0.1"
    replaceLineStartInBlock "${workspace}/glinkd/gamesys.conf" "[GProviderServer4]" "address" "address = 127.0.0.1"
    replaceLineStartInBlock "${workspace}/glinkd/gamesys.conf" "[GProviderServer5]" "address" "address = 127.0.0.1"
    replaceLineStartInBlock "${workspace}/glinkd/gamesys.conf" "[GProviderServer6]" "address" "address = 127.0.0.1"
    replaceLineStartInBlock "${workspace}/glinkd/gamesys.conf" "[GProviderServer7]" "address" "address = 127.0.0.1"
    replaceLineStartInBlock "${workspace}/glinkd/gamesys.conf" "[GFactionClient]" "address" "address = 127.0.0.1"
    replaceLineStartInBlock "${workspace}/glinkd/gamesys.conf" "[LogclientClient]" "address" "address = 127.0.0.1"
    replaceLineStartInBlock "${workspace}/glinkd/gamesys.conf" "[LogclientTcpClient]" "address" "address = 127.0.0.1"

    # Override /logservice/logservice.conf
    replaceLinesStart "${workspace}/logservice/logservice.conf" "threshhold" "threshhold = LOG_TRACE"
    replaceLinesStart "${workspace}/logservice/logservice.conf" "fd_err" "fd_err = ${workspace}/logs/pw.err"
    replaceLinesStart "${workspace}/logservice/logservice.conf" "fd_log" "fd_err = ${workspace}/logs/pw.log"
    replaceLinesStart "${workspace}/logservice/logservice.conf" "fd_formatlog" "fd_formatlog = ${workspace}/logs/pw.formatlog"
    replaceLinesStart "${workspace}/logservice/logservice.conf" "fd_trace" "fd_trace = ${workspace}/logs/pw.trace"
    replaceLinesStart "${workspace}/logservice/logservice.conf" "fd_chat" "fd_chat = ${workspace}/logs/pw.chat"
    replaceLinesStart "${workspace}/logservice/logservice.conf" "fd_cash" "fd_cash = ${workspace}/logs/pw.cash"
    replaceLinesStart "${workspace}/logservice/logservice.conf" "fd_statinfom" "fd_statinfom = ${workspace}/logs/statinfom"
    replaceLinesStart "${workspace}/logservice/logservice.conf" "fd_statinfoh" "fd_statinfoh = ${workspace}/logs/statinfoh"
    replaceLinesStart "${workspace}/logservice/logservice.conf" "fd_statinfod" "fd_statinfod = ${workspace}/logs/statinfod"

    # Override /uniquenamed/gamesys.conf
    replaceLineStartInBlock "${workspace}/uniquenamed/gamesys.conf" "[storage]" "homedir" "homedir = ${workspace}/uniquenamed/uname"
    replaceLineStartInBlock "${workspace}/uniquenamed/gamesys.conf" "[storage]" "datadir" "datadir = ${workspace}/uniquenamed/uname/dbdata"
    replaceLineStartInBlock "${workspace}/uniquenamed/gamesys.conf" "[storage]" "logdir" "logdir = ${workspace}/uniquenamed/uname/dblogs"
    replaceLineStartInBlock "${workspace}/uniquenamed/gamesys.conf" "[storage]" "backupdir" "backupdir = ${workspace}/uniquenamed/uname/backup"
    replaceLineStartInBlock "${workspace}/uniquenamed/gamesys.conf" "[storagewdb]" "homedir" "homedir = ${workspace}/uniquenamed/unamewdb/"
    replaceLineStartInBlock "${workspace}/uniquenamed/gamesys.conf" "[storagewdb]" "datadir" "datadir = ${workspace}/uniquenamed/unamewdb/dbdata"
    replaceLineStartInBlock "${workspace}/uniquenamed/gamesys.conf" "[storagewdb]" "logdir" "logdir = ${workspace}/uniquenamed/unamewdb/dblogs"
    replaceLineStartInBlock "${workspace}/uniquenamed/gamesys.conf" "[storagewdb]" "backupdir" "backupdir = ${workspace}/uniquenamed/unamewdb/backup"

    ./fetch --repo="https://github.com/hoangnguyent/pwtools" --ref="main" --source-path="/copy-to-etc/GMserver.conf" "/etc/GMserver.conf"

    # Sync files in folder /gamed/config between client and server. These 9 files should be copied manually.
    # 1. aipolicy.data
    # 2. elements.data
    # 3. gshop.data
    # 4. gshop1.data
    # 5. gshop2.data
    # 6. gshopsev.data
    # 7. gshopsev1.data
    # 8. gshopsev2.data
    # 9. tasks.data

}

function cleanUp(){
    rm -rf "${setupFolder}"
    rm -f /apache-tomcat-7.0.108.tar.gz
}

function note(){
    echo ""
    echo -e "If you are able to login and create character but ${P}unable to enter the game${W},"
    echo -e "please re-check the \"installDevPackages\" step."
    echo -e "Run this command to check which libraries are missing:"
    echo -e "ldd ${workspace}/gacd/gacd ${workspace}/gamed/gs ${workspace}/gamedbd/gamedbd ${workspace}/gdeliveryd/gdeliveryd ${workspace}/gfactiond/gfactiond ${workspace}/glinkd/glinkd ${workspace}/logservice/logservice ${workspace}/uniquenamed/uniquenamed"
    echo ""
}

function finallyEnd(){

    echo "${G}Script ended!${W}"

    endTime=$(date +%s)
    elapsedTime=$((endTime - startTime))
    elapsedMinutes=$((elapsedTime / 60))
    echo -e "\nTotal time: ${elapsedMinutes} minutes"

    note
}

function main(){

    switchTimezone
    startTime=$(date +%s)

    echo -e "${G}Script started!${W}"
    echo -e "Each step requires several minutes so be patient..."
    trap finallyEnd EXIT

    cd /

    echo -e "\nStep 1: Install the required packages."
    installSeverPackages

    echo -e "\nStep 2: Install the development related packages (C/C++, i386 libs, java)."
    installDevPackages
    installJdk6Manually

    echo -e "\nStep 3: Encode passwords."
    encodePassword

    echo -e "\nStep 4: Setup the database."
    setupDb
    enableToConnectDbFromOutside

    echo -e "\nStep 5: Setup the web tools."
    setupWebTools

    echo -e "\nStep 6: Download Perfect World Server."
    downloadGameServer

    echo -e "\nStep 7: Extract the Perfect World Server."
    chmod -R 777 "${setupFolder}"
    mkdir -p "${setupFolder}/${now}"
    extractGameServer
    putGameServerFoldersAtRightPlace

    echo -e "\nStep 8: Setup the Perfect World ${GAME_VERSION} Server."
    setupGameServer
    composeStartAndStopScript
    find "${workspace}/authd" -type f -name "authd.conf" -exec cp {} "/etc" \; -quit
    find "${workspace}/authd" -type f -name "table.xml" -exec cp {} "/etc" \; -quit

    echo -e "\nStep 9: Translate."
    #translateMapsIntoVietnamese
    #translateIwebIntoVietnamese

    echo -e "\nStep 10: Clean up."
    cleanUp

    echo -e "#######################################################################"
    echo -e "The Perfect World ${GAME_VERSION} game server has been completed."
    echo -e "Run ${G}/start${W} to start or ${G}/start trace${W} to start and tracing game issues."
    echo -e "#######################################################################"

}

# Execute
main
#main >> "$setupLogFile" 2>&1