#!/bin/bash

# Declare resources
DIR_MOUNT=/home # This must be one of your mount folders.
DIR_WORKING="" # As you wish. "" is also fine.
DOWNLOAD_URL="https://drive.usercontent.google.com/download?id=1UebfhrwJIWfP5cZvdra1tNWVZb8Is9PE&export=download&authuser=0&confirm=t&uuid=5c5a1d80-c934-4688-a7a9-6630f844de42"
DOWNLOAD_FILE_NAME="173v344.7z"

# Declare the structure of the file/folder that must stay inside the DOWNLOAD_FILE_NAME
STRUCTURE='{
    "authd"         : "dir",
    "gacd"          : "dir",
    "gamed"         : "dir",
    "gamedbd"       : "dir",
    "gdeliveryd"    : "dir",
    "gfactiond"     : "dir",
    "glinkd"        : "dir",
    "logservice"    : "dir",
    "uniquenamed"   : "dir"
}' # Do NOT left any trailing comma!!!

# Declare your virtualization info.
# If this IP is not localhost or 127.0.0.1, you may have to add it to /etc/hosts. Remember, this file is reset every time the Container reboots.
YOUR_VIRTUALIZATION_IP=127.0.0.1
YOUR_VIRTUALIZATION="docker" #docker or vmware or virtualbox or empty

# Declare database configuration
DB_NAME=pw
DB_USER=dba
DB_PASSWORD=dba

# Declare web tool configuration
PW_ADMIN_USER="admin"
PW_ADMIN_RAW_PW="admin"
PW_ADMIN_MAIL="admin@gmail.com"

# Declare hash algorithm. "hexEncoding" or "md5AndThenBase64encoding" or empty
#ALGORITHM="hexEncoding"
ALGORITHM="md5AndThenBase64encoding"

# Declare your info
GAME_VERSION=1.7.3
TIMEZONE=Asia/Ho_Chi_Minh

####################################################################################################
####################################################################################################
####################################################################################################
####################################################################################################
####################################################################################################

# Common variables
startTime=""
now=$(date +%Y%m%d_%H%M%S)
currentSQLDate=$(date +'%F %T');
iwebPasswordHash=""
pwAdminPasswordHash=""
workspace=""
if [ -n "${DIR_MOUNT}" ]; then
    workspace="${DIR_MOUNT}"
fi
if [ -n "${DIR_WORKING}" ]; then
    if [ -n "${workspace}" ]; then
        workspace="${workspace}/${DIR_WORKING}"
    else
        workspace="${DIR_WORKING}"
    fi
fi
if [[ "${workspace}" != /* ]]; then
    workspace="/${workspace}"
fi
setupFolder="${workspace}/${now}_setup"
setupLogFile="${workspace}/${now}_setup.log"
mkdir -p "${setupFolder}"
mkdir -p "${setupFolder}/pw"
chmod -R 777 "${workspace}"

# Text colors
B="[40;36m"
W="[0m"
G="[1;32m"
R="[1;31m"
Y="[1;33m"
P="[1;95m"

hostnamesResolution="127.0.0.1 AUDATA\n127.0.0.1 audb\n127.0.0.1 aumanager\n127.0.0.1 auth\n127.0.0.1 backup\n127.0.0.1 database\n127.0.0.1 delivery\n127.0.0.1 game1\n127.0.0.1 game2\n127.0.0.1 gm_server\n127.0.0.1 gmserver\n127.0.0.1 link1\n127.0.0.1 LOCAL0\n127.0.0.1 localhost\n127.0.0.1 localhost.localdomain\n127.0.0.1 LogServer\n127.0.0.1 manager\n127.0.0.1 PW-Server"
#hostCommand="if ! grep -q \"127.0.0.1 AUDATA\" /etc/hosts; then echo \"Docker Container reverts the /etc/hosts whenever it restarts. We are re-adding the hostnames resolution automatically...\"; echo -e \"${hostnamesResolution}\" >> /etc/hosts; fi"

function downloadGameServer(){
    #wget -c $DOWNLOAD_URL -O "${setupFolder}/${DOWNLOAD_FILE_NAME}"

    # If you don't want to download file but use an existing one,
    # just place you file in the workspace folder and use this:
    find "${DIR_MOUNT}" -type f -name "$DOWNLOAD_FILE_NAME" -exec rsync -avh {} "${setupFolder}" \; -quit

}

function switchTimezone(){
    ln -sf /usr/share/zoneinfo/$TIMEZONE /etc/localtime
}

function replaceLinesStart() {
    local file=$1
    local startWithText=$2
    local newLineReplacement=$3 # single line only

    # Escape backslashes and forward slashes in the newLineReplacement variable
    newLineReplacement=$(echo "${newLineReplacement}" | sed 's/[\/&]/\\&/g')

    if ! sed -i "/^${startWithText}/c\\${newLineReplacement}" "${file}"; then
        echo -e "replaceLinesStart failed with file ${file}"
        return 1
    fi
}

function replaceLinesContain() {
    local file=$1
    local containText=$2
    local newLineReplacement=$3 # single line only

    # Escape backslashes and forward slashes in the newLineReplacement variable
    newLineReplacement=$(echo "${newLineReplacement}" | sed 's/[\/&]/\\&/g')

    if ! sed -i "/${containText}/c\\${newLineReplacement}" "${file}"; then
        echo -e "replaceLinesContain failed with file ${file}"
        return 1
    fi
}

function replaceTexts() {
    local file=$1
    local containText=$2
    local newText=$3 # single line only

    # Escape backslashes and forward slashes in the newText variable
    newText=$(echo "${newText}" | sed 's/[\/&]/\\&/g')
    
    if ! sed -i "s#${containText}#${newText}#g" "${file}"; then
        echo -e "replaceTexts failed with file ${file}"
        return 1
    fi
}

function replaceLineStartInBlock() {
    local file=$1
    local blockName=$2
    local startWithText=$3
    local newLineReplacement=$4 # single line only

    # Escape special characters in blockName and startWithText
    local escapedBlockName=$(printf '%s\n' "$blockName" | sed 's/[]\/$*.^[]/\\&/g')
    local escapedStartWithText=$(printf '%s\n' "$startWithText" | sed 's/[]\/$*.^[]/\\&/g')

    # Check if the blockName exists in the file by starting with the blockName
    local blockIndex=$(grep -n "^${escapedBlockName}" "${file}" | cut -d: -f1 | head -n 1)
    if [ -z "${blockIndex}" ]; then
        echo -e "Block starting with '${blockName}' not found in the file ${file}."
        return 1
    fi

    # Find the nearest line that starts with startWithText after the blockIndex
    local lineIndex=$(awk -v blockIndex="${blockIndex}" -v startWithText="${escapedStartWithText}" 'NR > blockIndex && $0 ~ "^" startWithText {print NR; exit}' "${file}")
    if [ -z "${lineIndex}" ]; then
        echo -e "No line starting with '${startWithText}' found after block starting with '${blockName}'."
        return 1
    fi

    # Escape backslashes and forward slashes in the newLineReplacement variable
    newLineReplacement=$(echo "${newLineReplacement}" | sed 's/[\/&]/\\&/g')

    # Replace the line at lineIndex with newLineReplacement
    if ! sed -i "${lineIndex}s|.*|${newLineReplacement}|" "${file}"; then
        echo -e "replaceLineStartInBlock failed with file ${file}"
        return 1
    fi
}

function installSeverPackages(){

    dpkg --add-architecture i386
    apt-get install -y software-properties-common
    add-apt-repository -y universe

    apt update && apt -y upgrade
    apt install -y r-base
    apt install -y bash curl dpkg iputils-ping jq grep locales mc nano net-tools rsync sed wget
    apt install -y p7zip-full p7zip-rar unrar unzip

    # This is a tool to download specific folders from a Github repository.
    curl -sSLfo ./fetch https://github.com/gruntwork-io/fetch/releases/download/v0.4.6/fetch_linux_amd64
    chmod 777 ./fetch

    locale-gen en_US.UTF-8
    update-locale LANG=en_US.UTF-8
    export LC_ALL=en_US.UTF-8

}

function installDevPackages(){

    apt install -y aptitude
    aptitude install -y build-essential
    aptitude install -y libc6-dev zlib1g-dev libncurses5-dev libssl-dev libx11-dev libxext-dev libxrender-dev libxtst-dev
    aptitude install -y libc6:i386 libstdc++5:i386 libstdc++6:i386 zlib1g:i386 libncurses5:i386 libbz2-1.0:i386

    echo -e "Download additional libraries."
    ./fetch --repo="https://github.com/hoangnguyent/pwtools" --ref="main" --source-path="/additional-libs" "${setupFolder}/additional-libs"
    chmod -R 777 "${setupFolder}/additional-libs"
    cp -f "${setupFolder}/additional-libs/lib"/libcom_err.so.3 /lib
    cp -f "${setupFolder}/additional-libs/lib"/libcrypto.so.4 /lib
    cp -f "${setupFolder}/additional-libs/lib"/libpcre.so.0 /lib
    cp -f "${setupFolder}/additional-libs/lib"/libtask.so /lib
    #rsync -av --ignore-existing "${setupFolder}/additional-libs/lib"/* /lib

    ldconfig

}

function installJdk6Manually(){

    apt-get update
    apt-get install -y openjdk-8-jdk
    chmod -R 777 /usr/lib/jvm
    export JAVA_HOME=$(find /usr/lib/jvm -type d -name "java-*-openjdk*" -print -quit)
    export PATH=$JAVA_HOME/bin:$PATH
    java -version

}

function encodePassword(){

    # salt = user + pass
    iwebPasswordSalt=$(echo "${PW_ADMIN_RAW_PW}" | tr '[:upper:]' '[:lower:]')
    pwAdminPasswordSalt=$(echo "${PW_ADMIN_USER}${PW_ADMIN_RAW_PW}" | tr '[:upper:]' '[:lower:]')

    if [ "$ALGORITHM" == "hexEncoding" ]; then
        iwebPasswordHash=$(hexEncoding "$iwebPasswordSalt")
        pwAdminPasswordHash=$(hexEncoding "$pwAdminPasswordSalt")
    else
        iwebPasswordHash=$(echo -n "$PW_ADMIN_RAW_PW" | openssl dgst -md5 -binary | base64)
        pwAdminPasswordHash=$(echo -n "$pwAdminPasswordSalt" | openssl dgst -md5 -binary | base64)
    fi

}

function hexEncoding() {
    local salt="$1"
    local md5sum
    local hex_string="0x"

    # Generate MD5 hash
    md5sum=$(echo -n "$salt" | md5sum | awk '{print $1}')

    # Convert to uppercase and format as needed
    for (( i=0; i<${#md5sum}; i+=2 )); do
        hex_byte="${md5sum:$i:2}"
        hex_string+="$hex_byte"
    done

    echo "$hex_string"
}

function setupDb() {

    chmod -R 777 /etc
    chmod -R 777 /var/lib/mysql

    ./fetch --repo="https://github.com/hoangnguyent/pwtools" --ref="main" --source-path="/pwa.sql" "${setupFolder}/pwa.sql"

    # Remove database if exist
    service mysql stop
    apt-get remove -y --purge mariadb-server mariadb-client
    #apt-get remove -y --purge mariadb-common # I remove this command because it requires confirmation manually
    apt-get autoremove -y
    apt-get autoclean -y

    # Update package list and install database
    apt-get update
    apt-get install -y mariadb-server
    service mysql start

    # Create the database and insert 1 first record.
    mariadb -u"root" -p"123456" <<EOF
        DROP DATABASE IF EXISTS ${DB_NAME};
        CREATE DATABASE ${DB_NAME} CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
EOF

    mariadb -u"root" -p"123456" "${DB_NAME}" < "${setupFolder}/pwa.sql"

    mariadb -u"root" -p"123456" "${DB_NAME}" <<EOF
        CALL adduser("${PW_ADMIN_USER}", "${pwAdminPasswordHash}", "0", "0", "super admin", "0", "${PW_ADMIN_MAIL}", "0", "0", "0", "0", "0", "0", "0", "${currentSQLDate}", " ", "${pwAdminPasswordHash}");
EOF

    lastInsertedUserId=$(mariadb -u"root" -p"123456" "${DB_NAME}" -se "SELECT ID from users WHERE name=\"$PW_ADMIN_USER\"");
    echo "last inserted id: ${lastInsertedUserId}";
    if [[ "${lastInsertedUserId}" =~ ^[0-9]+$ ]]; then
        mariadb -u"root" -p"123456" "${DB_NAME}" <<EOF
            CALL addGM("${lastInsertedUserId}", "1");
            INSERT INTO usecashnow (userid, zoneid, sn, aid, point, cash, status, creatime) VALUES ("${lastInsertedUserId}", "1", "0", "1", "0", "100000", "1", "${currentSQLDate}") ON DUPLICATE KEY UPDATE cash = cash + 100000;
EOF
    fi

}

function enableToConnectDbFromOutside(){

    service mysql start

    # Grant permissions
    user_exists=$(mysql -u"root" -p"123456" -se "SELECT EXISTS(SELECT 1 FROM mysql.user WHERE user = '$DB_USER' AND host = 'localhost');")
    if [ "$user_exists" -eq 1 ]; then
        mysql -u"root" -p"123456" -e "DROP USER '$DB_USER'@'localhost';"
    fi
    mysql -u"root" -p"123456" -e "CREATE USER '$DB_USER'@'localhost' IDENTIFIED BY '$DB_PASSWORD';"
    mysql -u"root" -p"123456" -e "GRANT ALL PRIVILEGES ON *.* TO '$DB_USER'@'localhost';"
    mysql -u"root" -p"123456" -e "GRANT ALL PRIVILEGES ON $DB_NAME.* TO '$DB_USER'@'localhost';"

    user_exists=$(mysql -u"root" -p"123456" -se "SELECT EXISTS(SELECT 1 FROM mysql.user WHERE user = '$DB_USER' AND host = '${YOUR_VIRTUALIZATION_IP}');")
    if [ "$user_exists" -eq 1 ]; then
        mysql -u"root" -p"123456" -e "DROP USER '$DB_USER'@'${YOUR_VIRTUALIZATION_IP}';"
    fi
    mysql -u"root" -p"123456" -e "CREATE USER '$DB_USER'@'${YOUR_VIRTUALIZATION_IP}' IDENTIFIED BY '$DB_PASSWORD';"
    mysql -u"root" -p"123456" -e "GRANT ALL PRIVILEGES ON *.* TO '$DB_USER'@'${YOUR_VIRTUALIZATION_IP}';"
    mysql -u"root" -p"123456" -e "GRANT ALL PRIVILEGES ON $DB_NAME.* TO '$DB_USER'@'${YOUR_VIRTUALIZATION_IP}';"

    user_exists=$(mysql -u"root" -p"123456" -se "SELECT EXISTS(SELECT 1 FROM mysql.user WHERE user = '$DB_USER' AND host = '%');")
    if [ "$user_exists" -eq 1 ]; then
        mysql -u"root" -p"123456" -e "DROP USER '$DB_USER'@'%';"
    fi
    mysql -u"root" -p"123456" -e "CREATE USER '$DB_USER'@'%' IDENTIFIED BY '$DB_PASSWORD';"
    mysql -u"root" -p"123456" -e "GRANT ALL PRIVILEGES ON *.* TO '$DB_USER'@'%';"
    mysql -u"root" -p"123456" -e "GRANT ALL PRIVILEGES ON $DB_NAME.* TO '$DB_USER'@'%';"

    user_exists=$(mysql -u"root" -p"123456" -se "SELECT EXISTS(SELECT 1 FROM mysql.user WHERE user = '$DB_USER' AND host = '172.17.0.1');") # these are for Docker container only
    if [ "$user_exists" -eq 1 ]; then
        mysql -u"root" -p"123456" -e "DROP USER '$DB_USER'@'172.17.0.1';"
    fi
    mysql -u"root" -p"123456" -e "CREATE USER '$DB_USER'@'172.17.0.1' IDENTIFIED BY '$DB_PASSWORD';"
    mysql -u"root" -p"123456" -e "GRANT ALL PRIVILEGES ON *.* TO '$DB_USER'@'172.17.0.1';"
    mysql -u"root" -p"123456" -e "GRANT ALL PRIVILEGES ON $DB_NAME.* TO '$DB_USER'@'172.17.0.1';"


    mysql -u"root" -p"123456" -e "FLUSH PRIVILEGES;"

    # Allow all IP addresses outside the container.
    chmod 777 /etc/mysql/my.cnf
    if grep -q "^\[mysqld\]" /etc/mysql/my.cnf; then
        # Append settings to the [mysqld] section
        sed -i '/^\[mysqld\]/a \
log_error = /var/log/mysql/error.log\n
bind-address = 0.0.0.0\n
skip-name-resolve' /etc/mysql/my.cnf
    else
        # Add [mysqld] section and settings at the end of the file
        echo -e "\n[mysqld]\nlog_error = /var/log/mysql/error.log\nbind-address = 0.0.0.0\nskip-name-resolve" | tee -a /etc/mysql/my.cnf
    fi

    service mysql restart
}

function setupIwebJava(){

    if [ ! -d "${workspace}/tomcat" ]; then
        mkdir "${workspace}/tomcat"
        chmod -R 777 "${workspace}/tomcat"
    else
        rm -rf "${workspace}/tomcat"/*
    fi

    # Download Tomcat
    wget https://archive.apache.org/dist/tomcat/tomcat-7/v7.0.108/bin/apache-tomcat-7.0.108.tar.gz && tar -xzf apache-tomcat-7.0.108.tar.gz -C "${workspace}/tomcat" --strip-components=1
    chmod -R 777 "${workspace}/tomcat/bin"

    # Use my pwadmin (iweb)
    rm -rf "${workspace}"/tomcat/webapps/pwadmin
    ./fetch --repo="https://github.com/hoangnguyent/pwtools" --ref="main" --source-path="/pwadmin" "${workspace}"/tomcat/webapps/pwadmin

    # Override file /tomcat/webapps/pwadmin/WEB-INF/.pwadminconf.jsp: DB connection; game location; hash algorithm for iweb password.
    replaceLinesContain "${workspace}/tomcat/webapps/pwadmin/WEB-INF/.pwadminconf.jsp" "String db_host = " "String db_host = \"$YOUR_VIRTUALIZATION_IP\";"
    replaceLinesContain "${workspace}/tomcat/webapps/pwadmin/WEB-INF/.pwadminconf.jsp" "String db_user = " "String db_user = \"$DB_USER\";"
    replaceLinesContain "${workspace}/tomcat/webapps/pwadmin/WEB-INF/.pwadminconf.jsp" "String db_password = " "String db_password = \"$DB_PASSWORD\";"
    replaceLinesContain "${workspace}/tomcat/webapps/pwadmin/WEB-INF/.pwadminconf.jsp" "String db_database = " "String db_database = \"$DB_NAME\";"
    replaceLinesContain "${workspace}/tomcat/webapps/pwadmin/WEB-INF/.pwadminconf.jsp" "String algorithm = " "String algorithm = \"$ALGORITHM\";"
    replaceLinesContain "${workspace}/tomcat/webapps/pwadmin/WEB-INF/.pwadminconf.jsp" "String iweb_password = " "String iweb_password = \"$iwebPasswordHash\";"
    replaceLinesContain "${workspace}/tomcat/webapps/pwadmin/WEB-INF/.pwadminconf.jsp" "String pw_server_path = " "String pw_server_path = \"${workspace}/\";"
    replaceLinesContain "${workspace}/tomcat/webapps/pwadmin/WEB-INF/.pwadminconf.jsp" "String pw_server_name = " "String pw_server_name = \"${workspace}\";"

    # Override file /tomcat/webapps/pwadmin/addons/Top Players - Manual Refresh/index.jsp: DB connection. Replace the line that contains a text with a whole new line
    replaceLinesContain "${workspace}/tomcat/webapps/pwadmin/addons/Top Players - Manual Refresh/index.jsp" "connection = DriverManager.getConnection(" "connection = DriverManager.getConnection(\"jdbc:mysql://$YOUR_VIRTUALIZATION_IP:3306/$DB_NAME?useUnicode=true&characterEncoding=utf8\", \"$DB_USER\", \"$db_password\");"

}

function translateMapsIntoVietnamese() {

    echo -e "yes,gs01,Th·∫ø Gi·ªõi
yes,is61,Th·∫ø Gi·ªõi Ng∆∞·ªùi M·ªõi (1.5.3)
no,is62,Khung Th·∫ø Gi·ªõi (1.5.1)
no,is01,Th√†nh Ph·ªë T·ªôi √Åc
no,is02,ƒê∆∞·ªùng H·∫ßm B√≠ M·∫≠t
no,is03,na
no,is04,na
no,is05,Hang ƒê·ªông L·ª≠a
no,is06,Hang S√≥i ƒêi√™n
no,is07,Hang ƒê·ªông T√†n √Åc
no,is08,ƒê·∫°i S·∫£nh L·ª´a D·ªëi
no,is09,C·ªïng ·∫¢o Gi√°c
no,is10,Th√†nh Ph·ªë BƒÉng Gi√° B√≠ M·∫≠t
no,is11,Thung L≈©ng Th·∫£m H·ªça
no,is12,T√†n T√≠ch R·ª´ng
no,is13,Hang ƒê·ªông Vui S∆∞·ªõng T√†n B·∫°o
no,is14,C·ªïng Ma Qu√°i
no,is15,H√†o Trench ·∫¢o Gi√°c
no,is16,Eden
no,is17,H·ªë L·ª≠a
no,is18,ƒê·ªÅn R·ªìng
no,is19,ƒê·∫£o Ti·∫øng Th√©t ƒê√™m
no,is20,ƒê·∫£o R·∫Øn
yes,is21,Lothranis
yes,is22,Momaganon
no,is23,Ngai T√≤a ƒêau Kh·ªï
no,is24,Ma V·ª±c ƒê√†o Nguy√™n
no,is25,Chi·∫øn Ca Chi Th√†nh
no,is26,Lu√¢n H·ªìi ƒêi·ªán
no,is27,Th·∫ßn Nguy·ªát C·ªëc
no,is28,Th·∫ßn V√¥ C·ªëc
no,is29,Ph√∫c S∆∞∆°ng Th√†nh
no,is31,Ho√†ng H√¥n Th√°nh ƒêi·ªán
no,is32,V·∫≠n M·ªánh Ma Ph∆∞∆°ng
no,is33,Thi√™n L·ªá Chi Th√†nh
no,is34,Khung c·∫£nh H√¥n L·ªÖ
no,is35,Ph·ª• b·∫£n Bang Ph√°i
no,is37,B·ªìng Lai Huy·ªÖn C·∫£nh
no,is38,Ph∆∞·ª£ng Minh C·ªëc
no,is39,V√¥ ƒê·ªãnh Tr·ª•
no,is40,Th·∫ßn ƒê·ªôc Chi Gian
no,is41,V√¥ ƒê·ªänh Tr·ª•-m√¥ th·ª©c c·∫•p cao
no,is42,Chi·∫øn Th·∫ßn C·ªëc
no,is43,Ng≈© ƒê·∫ø Chi ƒê√¥
no,is44,Qu·ªëc Chi·∫øn-C√¥ ƒê·∫£o ƒêo·∫°t K√¨
no,is45,Qu·ªëc Chi·∫øn-ƒêo·∫°n Ki·ªÅu ƒê·ªëi Tr√¨
no,is46,Qu·ªëc Chi·∫øn-Th·ªßy Tinh Tranh ƒêo·∫°t
no,is47,L·∫°c Nh·∫≠t C·ªëc
no,is48,B·∫•t X√° ƒê∆∞·ªùng
no,is49,Long ·∫®n Qu·∫≠t
no,is50,Linh ƒê√†n Huy·ªÖn C·∫£nh
yes,is63,Nh√¢n Gi·ªõi
no,is66,L∆∞u Ng√¢n Cung
no,is67,Ph·ª•c Ba ƒê∆∞·ªùng
yes,is68,M√¥ th·ª©c C√¢u chuy·ªán Nh√¢n Gi·ªõi
yes,is69,B·ªìng Minh ƒê·ªông
no,is70,V·∫≠n M·ªánh Ma Ph∆∞∆°ng (2)
no,is71,Thi·ªán Long C·ªëc
no,is72,Tru Thi√™n Ph√π ƒê·ªì Th√°p (base)
no,is73,Tru Thi√™n Ph√π ƒê·ªì Th√°p (is73)
no,is74,Tru Thi√™n Ph√π ƒê·ªì Th√°p (is74)
no,is75,Tru Thi√™n Ph√π ƒê·ªì Th√°p (is75)
no,is76,Huy·ªÖn H·∫£i K√¨ ƒê√†m
no,is77,Thurs Fights Cross
yes,is78,ƒê·∫°i L·ª•c Ho√†n Mƒ© - T√¢y L·ª•c
no,is80,LƒÉng V√¢n Gi·ªõi
no,is81,LƒÉng V√¢n Gi·ªõi
no,is82,LƒÉng V√¢n Gi·ªõi
no,is83,LƒÉng V√¢n Gi·ªõi
no,bg01,ƒê·∫•u tr∆∞·ªùng T-3 PvP
no,bg02,ƒê·∫•u tr∆∞·ªùng T-3 PvE
no,bg03,ƒê·∫•u tr∆∞·ªùng T-2 PvP
no,bg04,ƒê·∫•u tr∆∞·ªùng T-2 PvE
no,bg05,ƒê·∫•u tr∆∞·ªùng T-1 PvP
no,bg06,ƒê·∫•u tr∆∞·ªùng T-1 PvE
no,arena01,ƒê·∫•u tr∆∞·ªùng Ki·∫øm Ti√™n Th√†nh
no,arena02,ƒê·∫•u tr∆∞·ªùng V·∫°n H√≥a Th√†nh
no,arena03,ƒê·∫•u tr∆∞·ªùng T√≠ch V≈© Th√†nh
no,arena04,ƒê·∫•u tr∆∞·ªùng T·ªï Long Th√†nh
no,rand03,Huy·ªÖn Sa Th·∫≠n C·∫£nh
no,rand04,M√™ Sa Huy·ªÖn C·∫£nh
" > "${workspace}/maps"

}

function translateIwebIntoVietnamese() {

    # Enable UTF-8 on the page.
    sed -i '1i <%@page contentType="text/html; charset=UTF-8" %>' "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp"

    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "City of Abominations" "Minh Th√∫ Th√†nh"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Secret Passage" "Anh H√πng Tr·ªßng"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Firecrag Grotto" "H·ªèa Nham ƒê·ªông Huy·ªát"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Den of Rabid Wolves" "Cu·ªìng Lang S√†o Huy·ªát"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Cave of the Vicious" "X√† H·∫°t ƒê·ªông"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Hall of Deception" "Thanh Y Tr·ªßng"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Gate of Delirium" "U Minh C∆∞"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Secret Frostcover Grounds" "L√≠ S∆∞∆°ng B√≠ C·∫£nh"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Valley of Disaster" "Thi√™n Ki·∫øp C·ªëc"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Forest Ruins" "T√πng L√¢m Di T√≠ch"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Cave of Sadistic Glee" "Qu·ª∑ V·ª±c Huy·ªÖn C·∫£nh"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Wraithgate" "O√°n Linh Chi M√¥n"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Hallucinatory Trench" "B√≠ B·∫£o Qu·∫≠t"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Eden" "Ti√™n Huy·ªÖn Thi√™n"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Brimstone Pit" "Ma Huy·ªÖn Thi√™n"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Temple of the Dragon" "Long Cung"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Nightscream Island" "D·∫° Kh·ªëc ƒê·∫£o"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Snake Isle" "V·∫°n X√† ƒê·∫£o"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Lothranis" "Ti√™n gi·ªõi"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Momaganon" "Ma gi·ªõi"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Seat of Torment" "Thi√™n Gi·ªõi Luy·ªán Ng·ª•c"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Abaddon" "Ma V·ª±c ƒê√†o Nguy√™n"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Warsong City" "Chi·∫øn Ca Chi Th√†nh"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Palace of Nirvana" "Lu√¢n H·ªìi ƒêi·ªán"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Lunar Glade" "Th·∫ßn Nguy·ªát C·ªëc"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Valley of Reciprocity" "Th·∫ßn V√¥ C·ªëc"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Frostcover City" "Ph√∫c S∆∞∆°ng Th√†nh"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Twilight Temple" "Ho√†ng H√¥n Th√°nh ƒêi·ªán"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Cube of Fate" "V·∫≠n M·ªánh Ma Ph∆∞∆°ng"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Chrono City" "Thi√™n L·ªá Chi Th√†nh"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Perfect Chapel" "Khung c·∫£nh H√¥n L·ªÖ"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Guild Base" "Ph·ª• b·∫£n Bang Ph√°i"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Morai" "B·ªìng Lai Huy·ªÖn C·∫£nh"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Phoenix Valley" "Ph∆∞·ª£ng Minh C·ªëc"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Endless Universe" "V√¥ ƒê·ªãnh Tr·ª•"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Blighted Chamer" "Th·∫ßn ƒê·ªôc Chi Gian"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Endless Universe" "V√¥ ƒê·ªänh Tr·ª•-m√¥ th·ª©c c·∫•p cao"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Wargod Gulch" "Chi·∫øn Th·∫ßn C·ªëc"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Five Emperors" "Ng≈© ƒê·∫ø Chi ƒê√¥"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Nation War 2" "Qu·ªëc Chi·∫øn-C√¥ ƒê·∫£o ƒêo·∫°t K√¨"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Nation Wa TOWER" "Qu·ªëc Chi·∫øn-Th·ªßy Tinh Tranh ƒêo·∫°t"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Nation War CRYSTAL" "Qu·ªëc Chi·∫øn-ƒêo·∫°n Ki·ªÅu ƒê·ªëi Tr√¨"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Sunset Valley" "L·∫°c Nh·∫≠t C·ªëc"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Shutter Palace" "B·∫•t X√° ƒê∆∞·ªùng"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Dragon Hidden Den" "Long ·∫®n Qu·∫≠t"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Realm of Reflection" "Linh ƒê√†n Huy·ªÖn C·∫£nh"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "startpoint" "Linh ƒê·ªô ƒêinh Ch√¢u"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Origination" "Khung Th·∫ø Gi·ªõi"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Primal World" "Nh√¢n Gi·ªõi"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Flowsilver Palace" "L∆∞u Ng√¢n Cung"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Undercurrent Hall" "Ph·ª•c Ba ƒê∆∞·ªùng"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Mortal Realm" "M√¥ th·ª©c C√¢u chuy·ªán Nh√¢n Gi·ªõi"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "LightSail Cave" "B·ªìng Minh ƒê·ªông"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Cube of Fate (2)" "V·∫≠n M·ªánh Ma Ph∆∞∆°ng (2)"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "dragon counqest" "Thi·ªán Long C·ªëc"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "heavenfall temple" "Tru Thi√™n Ph√π ƒê·ªì Th√°p"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "heavenfall temple" "Tru Thi√™n Ph√π ƒê·ªì Th√°p"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "heavenfall temple" "Tru Thi√™n Ph√π ƒê·ªì Th√°p"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "heavenfall temple" "Tru Thi√™n Ph√π ƒê·ªì Th√°p"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Uncharted Paradise" "Huy·ªÖn H·∫£i K√¨ ƒê√†m"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Thurs Fights Cross" "Thurs Fights Cross"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Western Steppes" "ƒê·∫°i L·ª•c Ho√†n Mƒ© - T√¢y L·ª•c"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Homestead, Beyond the Clouds" "LƒÉng V√¢n Gi·ªõi"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Homestead, Beyond the Clouds" "LƒÉng V√¢n Gi·ªõi"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Homestead, Beyond the Clouds" "LƒÉng V√¢n Gi·ªõi"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Homestead, Beyond the Clouds" "LƒÉng V√¢n Gi·ªõi"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Grape Valley, Grape Valley" "Grape Valley"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Nemesis Gaunntlet, Museum" "Linh Lung C·ª•c"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Dawnlight Halls, Palace of the Dawn (DR 1)" "Th·ª± Quang ƒêi·ªán (DR 1)"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Mirage Lake, Mirage Lake" "Huy·ªÖn C·∫£nh Th·∫≠n H·ªì"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Rosesand Ruins, Desert Ruins" "C√¥i M·∫°c T√†n Vi√™n"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Nightmare Woods, Forest Ruins" "Y·ªÉm L√¢m Ph·∫ø Kh∆∞"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Advisors Sanctum, Palace of the Dawn (DR 2)" "Th·ª± Quang ƒêi·ªán (DR 2)"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Wonderland, Adventure Kingdom (Park)" "K√¨ L·∫°c M·∫°o Hi·ªÉm V∆∞∆°ng Qu·ªëc"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "The Indestructible City" "M√¥ th·ª©c c√¢u chuy·ªán T√¢y L·ª•c"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Phoenix Sanctum, Hall of Fame" "Phoenix Sanctum, Hall of Fame"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Town of Arrivals, Battlefield - Dusk Outpost" "∆Ø·ªõc chi·∫øn Li√™n server - Long Chi·∫øn Chi D√£"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Icebound Underworld, Ice Hell (LA)" "BƒÉng V·ªçng ƒê·ªãa Ng·ª•c"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Doosan Station, Arena of the Gods" "Doosan Station, Arena of the Gods"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Alt TT Revisited, Twilight Palace" "Alt TT Revisited, Twilight Palace"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Spring Pass, Peach Abode (Mentoring)" "Spring Pass, Peach Abode (Mentoring)"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Abode of Dreams" "Abode of Dreams"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "White Wolf Pass" "White Wolf Pass"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Imperial Battle" "Imperial Battle"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Northern Lands" "Northern Lands"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Altar of the Virgin" "Altar of the Virgin"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Imperial Battle" "Imperial Battle"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Northern Lands" "Northern Lands"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Full Moon Pavilion" "Full Moon Pavilion"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Abode of Changes" "Abode of Changes"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "quicksand maze" "quicksand maze"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "quicksand maze" "quicksand maze"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Territory War T-3 PvP" "ƒê·∫•u tr∆∞·ªùng T-3 PvP"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Territory War T-3 PvE" "ƒê·∫•u tr∆∞·ªùng T-3 PvE"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Territory War T-2 PvP" "ƒê·∫•u tr∆∞·ªùng T-2 PvP"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Territory War T-2 PvE" "ƒê·∫•u tr∆∞·ªùng T-2 PvE"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Territory War T-1 PvP" "ƒê·∫•u tr∆∞·ªùng T-1 PvP"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Territory War T-1 PvE" "ƒê·∫•u tr∆∞·ªùng T-1 PvE"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Etherblade Arena" "ƒê·∫•u tr∆∞·ªùng Ki·∫øm Ti√™n Th√†nh"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Lost Arena" "ƒê·∫•u tr∆∞·ªùng V·∫°n H√≥a Th√†nh"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Plume Arena" "ƒê·∫•u tr∆∞·ªùng T√≠ch V≈© Th√†nh"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Archosaur Arenas" "ƒê·∫•u tr∆∞·ªùng T·ªï Long Th√†nh"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Quicksand Maze (Sandstorm Mirage)" "Huy·ªÖn Sa Th·∫≠n C·∫£nh"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Quicksand Maze (Mirage of the wandering sands)" "M√™ Sa Huy·ªÖn C·∫£nh"
    replaceTexts "${workspace}/tomcat/webapps/pwadmin/serverctrl.jsp" "Tomb of Whispers" "Tomb of Whispers"

    # C√≥ nhi·ªÅu map m√¨nh kh√¥ng t√¨m ƒë∆∞·ª£c t√™n ti·∫øng Vi·ªát, th·∫≠m ch√≠ d·ªãch b·ª´a. Ai bi·∫øt, xin ch·ªâ gi√πm nh√©.
}

function setupWebTools() {

    setupIwebJava

    # Other tools will be placed here.
}

function extractArchive() {

    local archiveFile=$1
    local to=$2

    # Check if the file exists
    if [ ! -f "${archiveFile}" ]; then
        echo "File '${archiveFile}' does not exist."
        return 1
    fi

    # Extract the file extension
    local extension="${archiveFile##*.}"

    # Extract the archive based on its extension
    case "${extension}" in
        7z)
            timeout 600 7z x -aoa -sccutf-8 -scsutf-8 -o"${to}" "${archiveFile}"
            ;;
        rar)
            timeout 600 unrar x -o+ "${archiveFile}" "${to}"
            ;;
        zip)
            timeout 600 unzip -o "${archiveFile}" -d "${to}"
            ;;
        gz)
            timeout 600 tar -xzf "${archiveFile}" -C "${to}"
            ;;
        *)
            echo "Unsupported file extension: ${extension}"
            return 1
            ;;
    esac

    echo -e "Extracted ${archiveFile} to ${to} successfully."
    return 0
}

function findSubFolderWithStructure() {
    local dirToScan=$1
    local structure=$2

    # Check if the directory to scan exists
    if [ ! -d "${dirToScan}" ]; then
        echo "Directory '${dirToScan}' does not exist."
        return 1
    fi

    # Parse the JSON structure
    local keys=$(echo "${structure}" | jq -r 'keys[]')
    local firstKey=$(echo "${keys}" | head -n 1)
    local firstType=$(echo "${structure}" | jq -r --arg key "$firstKey" '.[$key]')

    # Find all paths that contain the first key with the correct type
    local foundPaths=()
    if [ "${firstType}" == "dir" ]; then
        while IFS= read -r -d '' path; do
            foundPaths+=("$path")
        done < <(find "${dirToScan}" -type d -name "${firstKey}" -print0)
    elif [ "${firstType}" == "file" ]; then
        while IFS= read -r -d '' path; do
            foundPaths+=("$path")
        done < <(find "${dirToScan}" -type f -name "${firstKey}" -print0)
    fi

    # Check each found path for the remaining structure
    for path in "${foundPaths[@]}"; do
        local parentDir=$(dirname "$path")
        local allMatch=true

        for key in ${keys}; do
            local type=$(echo "${structure}" | jq -r --arg key "$key" '.[$key]')
            if [ "${type}" == "dir" ]; then
                if [ ! -d "${parentDir}/${key}" ]; then
                    allMatch=false
                    break
                fi
            elif [ "${type}" == "file" ]; then
                if [ ! -f "${parentDir}/${key}" ]; then
                    allMatch=false
                    break
                fi
            fi
        done

        if [ "$allMatch" = true ]; then
            echo "${parentDir}"
            return
        fi
    done

    # If no matching sub-folder is found, return an empty string
    echo ""
}

function moveGameServerToCorrectLocation(){

    pathFound=$(findSubFolderWithStructure "${setupFolder}/pw" "${STRUCTURE}")

    if [ -n "${pathFound}" ]; then
        echo -e "Moving Game server from ${pathFound} to ${setupFolder}/pw}"

        keys=$(echo "${STRUCTURE}" | jq -r 'keys[]')
        for item in ${keys}; do
            rsync -avh "${pathFound}/${item}" "${workspace}"
            chmod -R 777 "${workspace}/${item}"
        done

    else
        echo -e "No sub-folder that contains the specified structure of the Game Server found."
    fi

}

function composeStartAndStopScript(){

    # Download scripts
    ./fetch --repo="https://github.com/hoangnguyent/pwtools" --ref="main" --source-path="/bash" "${setupFolder}/bash"
    chmod -R 777 "${setupFolder}/bash"
    cp "${setupFolder}/bash"/server "${workspace}"
    cp "${setupFolder}/bash"/start "${workspace}"
    cp "${setupFolder}/bash"/stop "${workspace}"

    # Override file 'server' file : DB connection; [pwadmin] web tool location; and other info.
    replaceLinesStart "${workspace}/server" "# Last Updated:" "# Last Updated: $(date +'%Y/%m/%d')"
    replaceLinesStart "${workspace}/server" "# Require:" "# Require: Perfect World server v$GAME_VERSION"
    replaceLinesStart "${workspace}/server" "ServerDir=" "ServerDir=${workspace}"
    replaceLinesStart "${workspace}/server" "USR=" "USR=$DB_USER"
    replaceLinesStart "${workspace}/server" "PASSWD=" "PASSWD=$DB_PASSWORD"
    replaceLinesStart "${workspace}/server" "DB=" "DB=$DB_NAME"
    replaceLinesStart "${workspace}/server" "DIR_TOMCAT_BIN=" "DIR_TOMCAT_BIN=${workspace}/tomcat/bin"

    # Override the 'start' file
    replaceLinesStart "${workspace}/start" "PW_PATH=" "PW_PATH=${workspace}"
    replaceLinesContain "${workspace}/start" "# display pwadmin url here" "    echo \${G}\"http://${YOUR_VIRTUALIZATION_IP}:8080/pwadmin\"\${W}"
    replaceLinesContain "${workspace}/start" "# display warning about hosts here" "${hostCommand}"
    jdbcCommand="    echo \"Use: \${G}jdbc:mysql://$YOUR_VIRTUALIZATION_IP:3306/$DB_NAME?user=$DB_USER&password=$DB_PASSWORD\${W} to connect to the DB from outside the Docker container.\""
    replaceLinesContain "${workspace}/start" "# display jdbc string here" "${jdbcCommand}"

    # Override the test files (9). You should run them in this order.
    #cp "${setupFolder}/bash/test_"* "${workspace}"
    #replaceLinesStart "${workspace}/test_start_logservice" "PW_PATH=" "PW_PATH=${workspace}"
    #replaceLinesStart "${workspace}/test_start_uniquenamed" "PW_PATH=" "PW_PATH=${workspace}"
    #replaceLinesStart "${workspace}/test_start_authd" "PW_PATH=" "PW_PATH=${workspace}"
    #replaceLinesStart "${workspace}/test_start_gamedbd" "PW_PATH=" "PW_PATH=${workspace}"
    #replaceLinesStart "${workspace}/test_start_gacd" "PW_PATH=" "PW_PATH=${workspace}"
    #replaceLinesStart "${workspace}/test_start_gfactiond" "PW_PATH=" "PW_PATH=${workspace}"
    #replaceLinesStart "${workspace}/test_start_gdeliveryd" "PW_PATH=" "PW_PATH=${workspace}"
    #replaceLinesStart "${workspace}/test_start_glinkd" "PW_PATH=" "PW_PATH=${workspace}"
    #replaceLinesStart "${workspace}/test_start_gamed" "PW_PATH=" "PW_PATH=${workspace}"

    # Move start/stop to /
    mv -f "${workspace}/start" /
    mv -f "${workspace}/stop" /

    # Create file restart
    echo -e "./stop\n./start \"\$@\"" > "restart"

    # Grant permission
    chmod 777 "${workspace}/test_"*
    chmod 777 "start"
    chmod 777 "stop"
    chmod 777 "restart"

}

function setupGameServer(){

    # Override file /authd/authd. Sometimes this file stays in /build folder.
    path_table_xml=$(find "${workspace}/authd" -name "table.xml" -print -quit)

    if [ -n "${path_table_xml}" ]; then
        authd_path=$(dirname "${path_table_xml}")
        cat << EOF > "${authd_path}/authd"
#!/bin/sh
while true; do
    "${JAVA_HOME}/bin/java" -cp lib/application.jar:.:lib/commons-collections-3.1.jar:lib/commons-dbcp-1.2.1.jar:lib/commons-logging-1.0.4.jar:lib/commons-pool-1.2.jar:lib/jio.jar:lib/log4j-1.2.9.jar:lib/mysql-connector-java-5.1.10-bin.jar:.:.:"${JAVA_HOME}/lib/dt.jar":"${JAVA_HOME}/lib/tools.jar" authd table.xml
    sleep 2
done
EOF
    fi

    echo "authd location is: ${authd_path}"
    echo "table.xml location is: ${path_table_xml}"

    # Override file /authd/authd.conf
    replaceLineStartInBlock "${authd_path}/authd.conf" "[GAuthServer]" "mtrace" "mtrace = ${authd_path}/mtrace.authd"

    # Override file /authd/table.xml and copy it to /etc
    replaceLinesStart "${path_table_xml}" "<connection name=\"auth0\" poolsize=\"3\" url=\"jdbc:mysql" "<connection name=\"auth0\" poolsize=\"3\" url=\"jdbc:mysql://$YOUR_VIRTUALIZATION_IP:3306/$DB_NAME?useUnicode=true&amp;characterEncoding=utf8&amp;jdbcCompliantTruncation=false\" username=\"$DB_USER\" password=\"$DB_PASSWORD\"/>"

    # Override file /authd/log4j.properties
    echo "### direct log messages to CONSOLE ###
log4j.appender.CONSOLE=org.apache.log4j.ConsoleAppender
log4j.appender.CONSOLE.Target=System.out
log4j.appender.CONSOLE.layout=org.apache.log4j.PatternLayout
log4j.appender.CONSOLE.layout.ConversionPattern=gauthd: %d{dd MMM yyyy HH:mm:ss,SSS} %5p %c{1}:%L - %m%n
log4j.appender.CONSOLE.Threshold=TRACE

log4j.appender.SYSLOG=org.apache.log4j.net.SyslogAppender
log4j.appender.SYSLOG.facility=LOCAL0 
log4j.appender.SYSLOG.layout=org.apache.log4j.PatternLayout 
log4j.appender.SYSLOG.layout.ConversionPattern=gauthd: %-5p - %m%n 
log4j.appender.SYSLOG.SyslogHost=localhost
log4j.appender.SYSLOG.Threshold=TRACE

# Set root logger to TRACE level
log4j.rootLogger=trace, CONSOLE, SYSLOG
" > "${authd_path}/log4j.properties"

    # Override file /gacd/gamesys.conf
    replaceLinesContain "${workspace}/gacd/gamesys.conf" "mtrace" "mtrace = ${workspace}/logs/gacd.log"

    # Override file /gamed/gmserver.conf
    replaceLinesStart "${workspace}/gamed/gmserver.conf" "address" "address = 127.0.0.1"

    # Override file /gamed/gs.conf
    replaceLinesStart "${workspace}/gamed/gs.conf" "Root" "Root = ${workspace}/gamed/config"
    replaceLineStartInBlock "${workspace}/gamed/gs.conf" "[MsgTCPSession]" "address" "address = 127.0.0.1"

    # Override file /gamedbd/gamesys.conf
    replaceLineStartInBlock "${workspace}/gamedbd/gamesys.conf" "[storage]" "homedir" "homedir = ${workspace}/gamedbd/dbhome"
    replaceLineStartInBlock "${workspace}/gamedbd/gamesys.conf" "[storage]" "datadir" "datadir = ${workspace}/gamedbd/dbhome/dbdata"
    replaceLineStartInBlock "${workspace}/gamedbd/gamesys.conf" "[storage]" "logdir" "logdir = ${workspace}/gamedbd/dbhome/dblogs"
    replaceLineStartInBlock "${workspace}/gamedbd/gamesys.conf" "[storage]" "backupdir" "backupdir = ${workspace}/gamedbd/dbhome/backup"
    replaceLineStartInBlock "${workspace}/gamedbd/gamesys.conf" "[storage]" "cachesize" "cachesize = 99999999"
    replaceLineStartInBlock "${workspace}/gamedbd/gamesys.conf" "[storagewdb]" "homedir" "homedir = ${workspace}/gamedbd/dbhomewdb"
    replaceLineStartInBlock "${workspace}/gamedbd/gamesys.conf" "[storagewdb]" "datadir" "datadir = ${workspace}/gamedbd/dbhomewdb/dbdata"
    replaceLineStartInBlock "${workspace}/gamedbd/gamesys.conf" "[storagewdb]" "logdir" "logdir = ${workspace}/gamedbd/dbhomewdb/dblogs"
    replaceLineStartInBlock "${workspace}/gamedbd/gamesys.conf" "[storagewdb]" "backupdir" "backupdir = ${workspace}/gamedbd/dbhomewdb/backup"

    # Override file /gdeliveryd/gamesys.conf
    replaceLineStartInBlock "${workspace}/gdeliveryd/gamesys.conf" "[LogclientClient]" "address" "address = 127.0.0.1"
    replaceLineStartInBlock "${workspace}/gdeliveryd/gamesys.conf" "[LogclientTcpClient]" "address" "address = 127.0.0.1"
    replaceLineStartInBlock "${workspace}/gdeliveryd/gamesys.conf" "[GDeliveryServer]" "address" "address = 127.0.0.1"
    replaceLineStartInBlock "${workspace}/gdeliveryd/gamesys.conf" "[GAuthClient]" "address" "address = 127.0.0.1"
    replaceLineStartInBlock "${workspace}/gdeliveryd/gamesys.conf" "[GProviderServer]" "address" "address = 127.0.0.1"
    replaceLineStartInBlock "${workspace}/gdeliveryd/gamesys.conf" "[UniqueNameClient]" "address" "address = 127.0.0.1"
    replaceLineStartInBlock "${workspace}/gdeliveryd/gamesys.conf" "[GameDBClient]" "address" "address = 127.0.0.1"
    replaceLineStartInBlock "${workspace}/gdeliveryd/gamesys.conf" "[GAntiCheatClient]" "address" "address = 127.0.0.1"
    replaceLineStartInBlock "${workspace}/gdeliveryd/gamesys.conf" "[GFactionClient]" "address" "address = 127.0.0.1"
    replaceLineStartInBlock "${workspace}/gdeliveryd/gamesys.conf" "[CentralDeliveryServer]" "address" "address = 0.0.0.0"
    replaceLineStartInBlock "${workspace}/gdeliveryd/gamesys.conf" "[CentralDeliveryClient]" "address" "address = host.docker.internal"
    yourVirtualization=$(echo "$YOUR_VIRTUALIZATION" | tr '[:upper:]' '[:lower:]')
    if [[ "${yourVirtualization}" == *"docker"* ]]; then
        replaceLineStartInBlock "${workspace}/gdeliveryd/gamesys.conf" "[CentralDeliveryClient]" "address" "address = host.docker.internal"
    else
        replaceLineStartInBlock "${workspace}/gdeliveryd/gamesys.conf" "[CentralDeliveryClient]" "address" "address = ${YOUR_VIRTUALIZATION_IP}"
    fi

    # Override file /glinkd/gamesys.conf
    replaceLineStartInBlock "${workspace}/glinkd/gamesys.conf" "[GLinkServer1]" "address" "address = 0.0.0.0"
    replaceLineStartInBlock "${workspace}/glinkd/gamesys.conf" "[GLinkServer2]" "address" "address = 0.0.0.0"
    replaceLineStartInBlock "${workspace}/glinkd/gamesys.conf" "[GLinkServer3]" "address" "address = 0.0.0.0"
    replaceLineStartInBlock "${workspace}/glinkd/gamesys.conf" "[GLinkServer4]" "address" "address = 0.0.0.0"
    replaceLineStartInBlock "${workspace}/glinkd/gamesys.conf" "[GLinkServer5]" "address" "address = 0.0.0.0"
    replaceLineStartInBlock "${workspace}/glinkd/gamesys.conf" "[GLinkServer6]" "address" "address = 0.0.0.0"
    replaceLineStartInBlock "${workspace}/glinkd/gamesys.conf" "[GLinkServer7]" "address" "address = 0.0.0.0"
    replaceLineStartInBlock "${workspace}/glinkd/gamesys.conf" "[GDeliveryClient]" "address" "address = 127.0.0.1"
    replaceLineStartInBlock "${workspace}/glinkd/gamesys.conf" "[GProviderServer1]" "address" "address = 127.0.0.1"
    replaceLineStartInBlock "${workspace}/glinkd/gamesys.conf" "[GProviderServer2]" "address" "address = 127.0.0.1"
    replaceLineStartInBlock "${workspace}/glinkd/gamesys.conf" "[GProviderServer3]" "address" "address = 127.0.0.1"
    replaceLineStartInBlock "${workspace}/glinkd/gamesys.conf" "[GProviderServer4]" "address" "address = 127.0.0.1"
    replaceLineStartInBlock "${workspace}/glinkd/gamesys.conf" "[GProviderServer5]" "address" "address = 127.0.0.1"
    replaceLineStartInBlock "${workspace}/glinkd/gamesys.conf" "[GProviderServer6]" "address" "address = 127.0.0.1"
    replaceLineStartInBlock "${workspace}/glinkd/gamesys.conf" "[GProviderServer7]" "address" "address = 127.0.0.1"
    replaceLineStartInBlock "${workspace}/glinkd/gamesys.conf" "[GFactionClient]" "address" "address = 127.0.0.1"
    replaceLineStartInBlock "${workspace}/glinkd/gamesys.conf" "[LogclientClient]" "address" "address = 127.0.0.1"
    replaceLineStartInBlock "${workspace}/glinkd/gamesys.conf" "[LogclientTcpClient]" "address" "address = 127.0.0.1"

    # Override /logservice/logservice.conf
    replaceLinesStart "${workspace}/logservice/logservice.conf" "threshhold" "threshhold = LOG_TRACE"
    replaceLinesStart "${workspace}/logservice/logservice.conf" "fd_err" "fd_err = ${workspace}/logs/pw.err"
    replaceLinesStart "${workspace}/logservice/logservice.conf" "fd_log" "fd_err = ${workspace}/logs/pw.log"
    replaceLinesStart "${workspace}/logservice/logservice.conf" "fd_formatlog" "fd_formatlog = ${workspace}/logs/pw.formatlog"
    replaceLinesStart "${workspace}/logservice/logservice.conf" "fd_trace" "fd_trace = ${workspace}/logs/pw.trace"
    replaceLinesStart "${workspace}/logservice/logservice.conf" "fd_chat" "fd_chat = ${workspace}/logs/pw.chat"
    replaceLinesStart "${workspace}/logservice/logservice.conf" "fd_cash" "fd_cash = ${workspace}/logs/pw.cash"
    replaceLinesStart "${workspace}/logservice/logservice.conf" "fd_statinfom" "fd_statinfom = ${workspace}/logs/statinfom"
    replaceLinesStart "${workspace}/logservice/logservice.conf" "fd_statinfoh" "fd_statinfoh = ${workspace}/logs/statinfoh"
    replaceLinesStart "${workspace}/logservice/logservice.conf" "fd_statinfod" "fd_statinfod = ${workspace}/logs/statinfod"

    # Override /uniquenamed/gamesys.conf
    replaceLineStartInBlock "${workspace}/uniquenamed/gamesys.conf" "[storage]" "homedir" "homedir = ${workspace}/uniquenamed/uname"
    replaceLineStartInBlock "${workspace}/uniquenamed/gamesys.conf" "[storage]" "datadir" "datadir = ${workspace}/uniquenamed/uname/dbdata"
    replaceLineStartInBlock "${workspace}/uniquenamed/gamesys.conf" "[storage]" "logdir" "logdir = ${workspace}/uniquenamed/uname/dblogs"
    replaceLineStartInBlock "${workspace}/uniquenamed/gamesys.conf" "[storage]" "backupdir" "backupdir = ${workspace}/uniquenamed/uname/backup"
    replaceLineStartInBlock "${workspace}/uniquenamed/gamesys.conf" "[storagewdb]" "homedir" "homedir = ${workspace}/uniquenamed/unamewdb/"
    replaceLineStartInBlock "${workspace}/uniquenamed/gamesys.conf" "[storagewdb]" "datadir" "datadir = ${workspace}/uniquenamed/unamewdb/dbdata"
    replaceLineStartInBlock "${workspace}/uniquenamed/gamesys.conf" "[storagewdb]" "logdir" "logdir = ${workspace}/uniquenamed/unamewdb/dblogs"
    replaceLineStartInBlock "${workspace}/uniquenamed/gamesys.conf" "[storagewdb]" "backupdir" "backupdir = ${workspace}/uniquenamed/unamewdb/backup"

    ./fetch --repo="https://github.com/hoangnguyent/pwtools" --ref="main" --source-path="/copy-to-etc/GMserver.conf" "/etc/GMserver.conf"

    # Sync files in folder /gamed/config between client and server. These 9 files should be copied manually.
    # 1. aipolicy.data
    # 2. elements.data
    # 3. gshop.data
    # 4. gshop1.data
    # 5. gshop2.data
    # 6. gshopsev.data
    # 7. gshopsev1.data
    # 8. gshopsev2.data
    # 9. tasks.data

}

function cleanUp(){
    rm -rf "${setupFolder}"
    rm -f /apache-tomcat-7.0.108.tar.gz
}

function note(){
    echo ""
    echo -e "If you are able to login and create character but ${P}unable to enter the game${W},"
    echo -e "please re-check the \"installDevPackages\" step."
    echo -e "Run this command to check which libraries are missing:"
    echo -e "ldd ${workspace}/gacd/gacd ${workspace}/gamed/gs ${workspace}/gamedbd/gamedbd ${workspace}/gdeliveryd/gdeliveryd ${workspace}/gfactiond/gfactiond ${workspace}/glinkd/glinkd ${workspace}/logservice/logservice ${workspace}/uniquenamed/uniquenamed"
    echo ""
}

function finallyEnd(){

    echo "${G}Script ended!${W}"

    endTime=$(date +%s)
    elapsedTime=$((endTime - startTime))
    elapsedMinutes=$((elapsedTime / 60))
    echo -e "\nTotal time: ${elapsedMinutes} minutes"

    note
}

function main(){

    switchTimezone
    startTime=$(date +%s)

    echo -e "${G}Script started!${W}"
    echo -e "Each step requires several minutes so be patient..."
    trap finallyEnd EXIT

    cd /

    echo -e "\nStep 1: Install the required packages."
    installSeverPackages

    echo -e "\nStep 2: Install the development packages (C/C++, i386 libs)."
    installDevPackages

    echo -e "\nStep 3: Install Java."
    installJdk6Manually

    echo -e "\nStep 4: Encode passwords."
    encodePassword

    echo -e "\nStep 5: Setup the database."
    setupDb
    enableToConnectDbFromOutside

    echo -e "\nStep 6: Setup the web tools."
    setupWebTools

    echo -e "\nStep 7: Download Perfect World Server."
    downloadGameServer

    echo -e "\nStep 8: Extract the Perfect World Server. It may take a long time."
    extractArchive "${setupFolder}/${DOWNLOAD_FILE_NAME}" "${setupFolder}/pw"
    chmod -R 777 "${setupFolder}/pw"
    moveGameServerToCorrectLocation

    echo -e "\nStep 9: Setup the Perfect World ${GAME_VERSION} Server."
    setupGameServer
    composeStartAndStopScript
    find "${workspace}/authd" -type f -name "authd.conf" -exec cp {} "/etc" \; -quit
    find "${workspace}/authd" -type f -name "table.xml" -exec cp {} "/etc" \; -quit

    echo -e "\nStep 10: Translate."
    #translateMapsIntoVietnamese
    #translateIwebIntoVietnamese

    cleanUp

    echo -e "#######################################################################"
    echo -e "The Perfect World ${GAME_VERSION} game server has been completed."
    echo -e "Run ${G}/start${W} to start or ${G}/start trace${W} to start and tracing game issues."
    echo -e "#######################################################################"

}

# Execute
main
#main >> "$setupLogFile" 2>&1
